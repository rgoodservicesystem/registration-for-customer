<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Customer Portal ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</title>

<!-- Supabase UMD (mobile friendly) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f6fbff; --ink:#0f172a; --mut:#6b7280; --card:#ffffff; --border:#e6eef5;
    --accent:#0ea5a5; --accent2:#60a5fa; --radius:16px;
    --ok:#065f46; --warn:#b45309; --exp:#b91c1c;
    --glass: rgba(255,255,255,0.7);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:"Prompt",system-ui,-apple-system,Segoe UI,Roboto; color:var(--ink);
    background:
      radial-gradient(1000px 500px at 10% -10%, #e6f7ff 0%, transparent 60%),
      radial-gradient(900px 450px at 110% 0%, #e8fff6 0%, transparent 60%),
      var(--bg);
    -webkit-font-smoothing:antialiased;
  }
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,1));
    border:1px solid var(--border); border-radius:16px;
    padding:18px; box-shadow:0 10px 30px rgba(13,40,70,0.06); margin-bottom:16px;
  }
  .top-row{display:flex;gap:12px;align-items:center}
  h1{margin:0;font-size:20px;font-weight:700;color:#054e4e}
  .mut{color:var(--mut);font-size:14px}
  input,button,select,textarea{
    padding:12px 12px;border-radius:12px;border:1px solid var(--border);
    background:#fff;color:var(--ink);font-size:15px;
  }
  input:focus, button:focus { outline: none; box-shadow: 0 6px 18px rgba(14,165,166,0.12); border-color: var(--accent); }
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .spacer{flex:1}
  .btn{cursor:pointer; background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff; font-weight:700; border:none; padding:12px 16px; border-radius:12px}
  .btn-ghost{background:#fff; color:#0e7490; border:1px solid #cfeef8}
  .btn-note{padding:8px 10px;border-radius:10px;border:1px solid #d7eef4;background:#f8feff;color:#0e7490;cursor:pointer}
  .small{font-size:13px;color:var(--mut)}
  /* nice company header */
  .company-head{display:flex;gap:16px;align-items:center}
  .logo-placeholder{width:72px;height:72px;border-radius:12px;background:linear-gradient(135deg,#fff,#f0f9ff);display:flex;align-items:center;justify-content:center;font-size:28px;border:1px solid #e6f7f7}
  .company-meta{display:flex;flex-direction:column}
  .company-name{font-size:18px;font-weight:800;color:#08363a}
  .company-sub{color:var(--mut);font-size:13px;margin-top:3px}
  /* filters */
  .filter-btn{padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;background:#f8feff;color:#0e7490;border:1px solid #e0f2f2}
  .active-filter{background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff;border-color:transparent}
  /* table */
  .table-wrap{overflow:auto; max-height:56vh; margin-top:12px; border-radius:12px; border:1px solid var(--border)}
  table{width:100%; border-collapse:collapse; min-width:980px; background:transparent}
  thead th{position:sticky;top:0;background:linear-gradient(180deg,#f7fbff,#f2f8ff);color:#064e57;padding:14px 16px;text-align:left;font-weight:700}
  th,td{padding:12px 16px;border-bottom:1px solid #f0f6fb;vertical-align:top;font-size:15px}
  tbody tr:nth-child(odd){background:linear-gradient(180deg, rgba(255,255,255,0.85), rgba(250,252,255,0.85))}
  tbody tr:hover{background:#fffbe8}
  .mut-cell{color:var(--mut);font-size:13px}
  .badge{padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px;display:inline-block}
  .ok{ color:var(--ok); background:#ecfdf5;border:1px solid #a7f3d090}
  .warn{ color:var(--warn); background:#fff7ed;border:1px solid #fde68a80}
  .exp{ color:var(--exp); background:#fff1f2;border:1px solid #fecaca90}
  /* modal */
  #noteModal{position:fixed;inset:0;display:none;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:9999;padding:20px}
  #noteBox{background:#fff;padding:20px;border-radius:14px;max-width:720px;width:100%;box-shadow:0 12px 40px rgba(5,30,50,0.2)}
  /* responsive */
  @media (max-width:900px){
    .table-wrap{max-height:48vh}
    table{min-width:900px}
  }
  @media (max-width:600px){
    .logo-placeholder{width:56px;height:56px;font-size:22px}
    thead th, th, td{padding:10px}
    table{min-width:800px}
  }
  /* --- ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏° (‡πÄ‡∏ô‡πâ‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤) --- */
  
  /* 1. ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Badge) */
  .badge {
    font-size: 13px !important;    /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏±‡∏î */
    padding: 4px 8px !important;   /* ‡∏Ç‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏´‡∏ô‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
    white-space: nowrap;           /* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
    vertical-align: middle;
    border-radius: 6px;            /* ‡∏°‡∏∏‡∏°‡∏°‡∏ô‡∏ô‡∏¥‡∏î‡πÜ */
    font-weight: 600;              /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤‡∏û‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì */
    border: 1px solid transparent; /* ‡∏à‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö */
  }

  /* 2. ‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà" */
  .change {
    color: #9d174d !important;        
    background: #fce7f3 !important;   
    border: 1px solid #f472b6 !important; /* ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡∏ä‡∏±‡∏î‡πÜ */
  }

  /* 3. ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Admin) */
  .btn.small, .btn-ghost.small {
    font-size: 13px !important;    /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏° */
    padding: 4px 8px !important;   /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏î‡πÉ‡∏´‡πâ‡∏à‡∏¥‡πâ‡∏°‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
    height: auto;
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- top card: input -->
  <div class="card">
    <div class="top-row">
      <h1>Customer Portal ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h1>
      <div class="spacer"></div>
      <button id="helpBtn" class="btn-ghost">‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</button>
    </div>
    <div style="margin-top:10px" class="mut small">‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (plain code) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ñ‡∏∏‡∏ì</div>

    <div style="margin-top:14px" class="row">
      <input id="code" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô RG-1234" autocomplete="one-time-code" inputmode="text" style="min-width:320px">
      <button id="enterBtn" class="btn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <div class="spacer"></div>
      <button id="toSummaryBtn" class="btn-ghost">‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
    <div id="loading" class="mut" style="margin-top:8px; display:none">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    <div id="err" class="mut" style="color:#b91c1c;margin-top:8px"></div>
  </div>

  <!-- company header -->
  <div id="companyCard" class="card" style="display:none">
    <div class="company-head">
      <div class="logo-placeholder" id="companyLogo">üçØ</div>
      <div class="company-meta">
        <div class="company-name" id="companyName">‚Äî</div>
        <div class="company-sub" id="companyCode">‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ‚Äî</div>
      </div>
      <div class="spacer"></div>
      <div style="text-align:right">
        <div class="small" style="margin-bottom:6px">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°</div>
        <div id="summaryBadges" style="display:flex;gap:8px;align-items:center"></div>
      </div>
    </div>
  </div>

  <!-- data card -->
  <div class="card" id="dataCard" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center;">
      <div style="display:flex;flex-direction:column">
        <div class="mut">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</div>
        <div class="small mut" id="updatedInfo" style="margin-top:6px"></div>
      </div>
      <div class="spacer"></div>
      <input id="q" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç / ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ / ‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" style="min-width:260px">
      <button id="clearBtn" class="btn-ghost">‡∏•‡πâ‡∏≤‡∏á</button>
      <button id="refreshBtn" class="btn">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
    </div>

    <div class="row" style="margin-top:12px;align-items:center">
      <div class="mut" style="font-weight:600">‡πÅ‡∏™‡∏î‡∏á:</div>
      <button id="filterAll" class="filter-btn active-filter">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button id="filterImport" class="filter-btn">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
      <button id="filterRepack" class="filter-btn">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏</button>
      <div class="spacer"></div>
      <div id="count" class="mut">‚Äî</div>
    </div>

    <div class="table-wrap" style="margin-top:12px">
      <table>
        <thead>
          <tr>
            <th style="width:48px">#</th>
            <th>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£</th>
            <th>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
            <th>‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</th>
            <th>‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï/‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï</th>
            <th>‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</th>
            <th>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏</th>
            <th>‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
            <th>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="12" class="mut">‚Äî</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal: ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ -->
<div id="noteModal" aria-hidden="true">
  <div id="noteBox" role="dialog" aria-modal="true" aria-label="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏">
    <h3 style="margin:0 0 8px">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</h3>
    <p id="noteBrand" style="margin:4px 0; font-weight:600">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤: ‚Äî</p>
    <p id="noteStatus" style="margin:4px 0">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‚Äî</p>
    <div id="noteText" style="margin-top:8px; white-space:pre-wrap; color:var(--mut)"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button id="closeNote" class="btn">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>

<script>
/* ============ Supabase config ============ */
const SUPABASE_URL = 'https://jlrogimfjmtwdqiuyejj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impscm9naW1mam10d2RxaXV5ZWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDIyODUsImV4cCI6MjA3NTUxODI4NX0.OvX7qgcIF5aCcLebUEUR_6D2KTUP2pALCjRtHWJ5qZg';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const $ = id => document.getElementById(id);
// ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 2 ‡∏õ‡∏µ (730 ‡∏ß‡∏±‡∏ô) ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏•‡∏á
const WARNING_DAYS = 365 * 2;

let CURRENT_CODE = '';
let FULL_ROWS = [];
let FILTERED = [];
let CURRENT_FILTER_TYPE = 'ALL'; // ALL, IMPORT, REPACK

/* ============ helpers ============ */
function escapeHtml(s){ return String(s ?? '').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function fmtDateBE(d){
  if(!d) return '-';
  const t = new Date(d);
  if(isNaN(t)) return '-';
  try{
    return t.toLocaleDateString('th-TH-u-ca-buddhist', { year:'numeric', month:'short', day:'numeric', timeZone:'Asia/Bangkok' });
  }catch(e){ return t.toISOString().slice(0,10); }
}

/* ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ï‡∏Å‡∏õ‡∏µ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏ß‡∏±‡∏ô ‡πÅ‡∏ö‡∏ö‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì) */
function diffYMD(fromDate, toDate){
  if(!toDate) return null;
  const f = new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate());
  const t = new Date(toDate.getFullYear(), toDate.getMonth(), toDate.getDate());
  if(isNaN(t)) return null;
  if(t < f) return { years:0, months:0, days:-Math.ceil((f - t)/86400000) , totalDays: Math.ceil((t - f)/86400000) };

  let years = t.getFullYear() - f.getFullYear();
  let months = t.getMonth() - f.getMonth();
  let days = t.getDate() - f.getDate();

  if(days < 0){
    // ‡∏¢‡∏∑‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô
    months -= 1;
    const prevMonth = new Date(t.getFullYear(), t.getMonth(), 0); // last day of previous month
    days = (prevMonth.getDate() - f.getDate()) + t.getDate();
  }
  if(months < 0){
    years -= 1;
    months += 12;
  }
  const totalDays = Math.ceil((t - f)/86400000);
  return { years, months, days, totalDays };
}

function humanRemainingExact(diffDays, expiryDate){
  if(diffDays === null || diffDays === undefined) return '';
  const eff = expiryDate ? new Date(expiryDate) : null;
  if(!eff) return '';
  if(diffDays < 0){ return `‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß ${Math.abs(diffDays)} ‡∏ß‡∏±‡∏ô`; }
  const ymd = diffYMD(new Date(), eff);
  if(!ymd) return '';
  const parts = [];
  if(ymd.years > 0) parts.push(`${ymd.years} ‡∏õ‡∏µ`);
  if(ymd.months > 0) parts.push(`${ymd.months} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`);
  if(ymd.years === 0 && ymd.months === 0) parts.push(`${ymd.days} ‡∏ß‡∏±‡∏ô`);
  return parts.join(' ');
}

function statusBadge(row){
  if(row?.status_text) return `<span class="badge warn">${escapeHtml(row.status_text)}</span>`;
  if(row?.renewed_status){
    // >> ‡πÅ‡∏ó‡∏£‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ <<
    if(row.renewed_status.includes('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á')) return `<span class="badge change">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà</span>`;
    if(row.renewed_status.includes('‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠')) return `<span class="badge exp">‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</span>`;
    if(row.renewed_status.includes('‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á')||row.renewed_status.includes('‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á')) return `<span class="badge warn">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>`;
    if(row.renewed_status.includes('‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß')) return `<span class="badge ok">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</span>`;
  }
  const eff = row?.expiry_date ? new Date(row.expiry_date) : null;
  if(!eff || isNaN(eff)) return `<span class="badge ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>`;
  const diff = Math.ceil((eff - new Date())/86400000);
  if(diff < 0) return `<span class="badge exp">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>`;
  if(diff <= WARNING_DAYS){
    const human = humanRemainingExact(diff, eff);
    return `<span class="badge warn">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${human}</span>`;
  }
  const human = humanRemainingExact(diff, eff);
  return `<span class="badge ok">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${human}</span>`;
}

/* ============ render ============ */
function render(q=''){
  const tb = $('tbody');
  const rows = FILTERED;
  if(rows.length === 0){
    tb.innerHTML = `<tr><td colspan="12" class="mut">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö ‚Äú${escapeHtml(q)}‚Äù</td></tr>`;
  }else{
   // ‡πÅ‡∏õ‡∏∞‡∏ó‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô tb.innerHTML ... ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
    tb.innerHTML = rows.map((r,i)=> {

      // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏´‡∏¢‡∏∏‡∏î‡∏Ñ‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏≠‡∏∞‡πÑ‡∏£ ---
      let rowClass = ''; // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏°‡∏≤‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏≤‡∏™
      
      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á" ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏≤‡∏™‡πÄ‡∏õ‡πá‡∏ô 'row-change'
      if(r.renewed_status && r.renewed_status.includes('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á')) {
         rowClass = 'row-change';
      }

      // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏™‡πà‡∏á HTML ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ (‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏ï‡∏£‡∏á <tr class="...">) ---
      return `
      <tr class="${rowClass}">  <td style="width:48px">${i+1}</td>
        <td>${escapeHtml(r.company_name||r.company_code||'-')}</td>
        <td>${escapeHtml(r.brand_name||'-')}</td>
        <td>${escapeHtml(r.common_label||'-')}</td>
        <td>${escapeHtml(r.registration_no||'-')}</td>
        <td class="mut-cell">${escapeHtml(r.importer||'-')}</td>
        <td class="mut-cell">${escapeHtml(r.manufacturer_source||'-')}</td>
        <td class="mut-cell">${escapeHtml(r.distributor||'-')}</td>
        <td class="mut-cell">${escapeHtml(r.packed_volume||'-')}</td>
        <td class="mut-cell">${r.registration_date?fmtDateBE(r.registration_date):'-'}</td>
        <td class="mut-cell">${r.expiry_date?fmtDateBE(r.expiry_date):'-'}</td>
        <td>
  ${statusBadge(r)}
  
  ${ r.renewed_note && r.renewed_note.trim() !== '' ? `
      <div style="margin-top:6px; display:block;">
        <span style="display:inline-block; font-size:13px; color:#334155; background:#f8fafc; padding:4px 10px; border-radius:6px; border:1px solid #e2e8f0; text-align:left;">
           üìù ${escapeHtml(r.renewed_note.trim())}
        </span>
      </div>
  ` : '' }
</td>
      </tr>
    `}).join('');
    tb.querySelectorAll('.btn-note').forEach(btn=>{
      btn.addEventListener('click', ev=>{
        const idx = Number(ev.currentTarget.getAttribute('data-index'));
        showNote(FILTERED[idx]);
      });
    });
  }
  $('count').textContent = `‡πÅ‡∏™‡∏î‡∏á ${rows.length.toLocaleString('th-TH')} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${FULL_ROWS.length.toLocaleString('th-TH')})`;
  updateSummaryBadges();
}

/* ============ filtering ============ */
function normalize(s){
  return String(s||'').toLowerCase().replace(/[‡πê-‡πô]/g, d => '‡πê‡πë‡πí‡πì‡πî‡πï‡πñ‡πó‡πòŸ©'.indexOf(d)).replace(/\s+/g,' ').trim();
}

function applyFilter(){
  const raw = $('q').value || '';
  const tokens = raw.trim().toLowerCase().split(/\s+/).filter(Boolean);

  // type filter
  let typeFiltered = FULL_ROWS;
  if (CURRENT_FILTER_TYPE === 'IMPORT') {
    typeFiltered = FULL_ROWS.filter(r => (String(r.packed_volume||'').toLowerCase().includes('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤') || String(r.importer||'').toLowerCase().includes('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤')) && !String(r.packed_volume||'').toLowerCase().includes('‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏'));
  } else if (CURRENT_FILTER_TYPE === 'REPACK') {
    typeFiltered = FULL_ROWS.filter(r => String(r.packed_volume||'').toLowerCase().includes('‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏'));
  }

  if(tokens.length === 0){ FILTERED = [...typeFiltered]; render(raw); return; }

  FILTERED = typeFiltered.filter(r=>{
    const hay = normalize([r.company_name, r.brand_name, r.common_label, r.registration_no, r.importer, r.manufacturer_source, r.distributor, r.packed_volume, r.renewed_note, r.renewed_status].join(' '));
    return tokens.every(t => hay.includes(normalize(t)));
  });
  render(raw);
}

/* ============ load data by code ============ */
async function loadCompanyByCode(){
  if(!CURRENT_CODE) return;
  $('loading').style.display = 'block';
  $('err').textContent = '';
  try{
    // get company name
    const { data: comp, error: compErr } = await sb.from('companies').select('id,name,plain_code,metadata').eq('plain_code', CURRENT_CODE).limit(1).maybeSingle();
    if(compErr){ console.warn('companies select error', compErr); }
    if(comp && comp.name){
      $('companyName').textContent = comp.name;
      $('companyCode').textContent = `‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${comp.plain_code || CURRENT_CODE}`;
      // optionally set logo if metadata contains logo_url
      if(comp.metadata && comp.metadata.logo_url){
        document.getElementById('companyLogo').innerHTML = '';
        document.getElementById('companyLogo').style.backgroundImage = `url(${comp.metadata.logo_url})`;
        document.getElementById('companyLogo').style.backgroundSize = 'cover';
        document.getElementById('companyLogo').style.backgroundPosition = 'center';
      } else {
        document.getElementById('companyLogo').textContent = comp && comp.name ? comp.name.trim().slice(0,2).toUpperCase() : 'üçØ';
      }
    } else {
      $('companyName').textContent = CURRENT_CODE;
      $('companyCode').textContent = `‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${CURRENT_CODE}`;
      document.getElementById('companyLogo').textContent = 'üçØ';
    }

    // RPC to fetch rows
    const res = await sb.rpc('get_company_portal', { p_plain_code: CURRENT_CODE });
    if(res.error){
      $('err').textContent = res.error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
      $('dataCard').style.display='none';
      $('companyCard').style.display='none';
      $('loading').style.display = 'none';
      return;
    }

    FULL_ROWS = (res.data || []).map(x=>({
      ...x,
      renewed_status: x.renewed_status || (x.renewed_until ? '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß' : null),
      company_name: (comp && comp.name) ? comp.name : (x.company_code || CURRENT_CODE)
    }));

    // visible
    $('companyCard').style.display = 'block';
    $('dataCard').style.display = 'block';
    $('loading').style.display = 'none';

    // updated info
    const now = new Date();
    $('updatedInfo').textContent = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${now.toLocaleString('th-TH', { timeZone:'Asia/Bangkok'})}`;

    // init filters/search
    const qs = new URLSearchParams(location.search);
    const initQ = qs.get('q') || '';
    $('q').value = initQ;
    FILTERED = [...FULL_ROWS];
    applyFilter();
  }catch(e){
    console.error(e);
    $('err').textContent = e.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    $('dataCard').style.display = 'none';
    $('companyCard').style.display = 'none';
    $('loading').style.display = 'none';
  }
}

/* ============ modal note ============ */
function showNote(row){
  $('noteBrand').textContent = `‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤: ${row.brand_name || '-'}`;
  $('noteStatus').textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${row.renewed_status || row.status_text || '-'}`;
  const raw = row.renewed_note || '-';
  $('noteText').innerHTML = escapeHtml(raw).replace(/\n/g,'<br>');
  $('noteModal').style.display = 'flex';
}

/* ============ summary badges ============ */
function updateSummaryBadges(){
  const container = document.getElementById('summaryBadges');
  if(!container) return;
  const total = FULL_ROWS.length;
  const expired = FULL_ROWS.filter(r => r.expiry_date && (new Date(r.expiry_date) < new Date())).length;
  const withinWarn = FULL_ROWS.filter(r => {
    if(!r.expiry_date) return false;
    const diff = Math.ceil((new Date(r.expiry_date) - new Date())/86400000);
    return diff > 0 && diff <= WARNING_DAYS;
  }).length;
  container.innerHTML = `
    <span class="badge ok">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${total}</span>
    <span class="badge warn">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ${withinWarn}</span>
    <span class="badge exp">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ${expired}</span>
  `;
}

/* ============ filter type handlers ============ */
function setFilterType(type, btnId){
  CURRENT_FILTER_TYPE = type;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active-filter'));
  document.getElementById(btnId).classList.add('active-filter');
  applyFilter();
}

/* ============ events ============ */
document.addEventListener('DOMContentLoaded', ()=>{
  $('enterBtn').addEventListener('click', async ()=>{
    const code = $('code').value.trim().toUpperCase();
    if(!code){ $('err').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'; return; }
    CURRENT_CODE = code;
    $('err').textContent = '';
    await loadCompanyByCode();
  });
  $('code').addEventListener('keydown', e=>{ if(e.key==='Enter') $('enterBtn').click(); });
  $('refreshBtn').addEventListener('click', loadCompanyByCode);
  $('q').addEventListener('input', applyFilter);
  $('clearBtn').addEventListener('click', ()=>{ $('q').value=''; applyFilter(); });

  $('closeNote').addEventListener('click', ()=> $('noteModal').style.display='none');
  $('noteModal').addEventListener('click', e=>{ if(e.target.id==='noteModal') $('noteModal').style.display='none'; });

  document.getElementById('filterAll').addEventListener('click', ()=> setFilterType('ALL','filterAll'));
  document.getElementById('filterImport').addEventListener('click', ()=> setFilterType('IMPORT','filterImport'));
  document.getElementById('filterRepack').addEventListener('click', ()=> setFilterType('REPACK','filterRepack'));

  // init from URL ?code=
  const params = new URLSearchParams(location.search);
  const code = params.get('code');
  if(code){
    $('code').value = code;
    CURRENT_CODE = code.trim().toUpperCase();
    loadCompanyByCode();
  }

  $('toSummaryBtn').addEventListener('click', ()=>{
    const code = ($('code').value || '').trim().toUpperCase();
    if(!code){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô'); return; }
    location.href = `summary.html?code=${encodeURIComponent(code)}`;
  });
});
</script>
</body>
</html>
