<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Registration Dashboard ‚Äî Perfect Date View</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #f8fafc; --primary: linear-gradient(135deg, #0ea5a5, #14b8a6);
    --danger: #ef4444; --warning: #f59e0b; --ok: #10b981;
    --dark: #0f172a; --ink: #1e293b; --mut: #64748b;
  }

  body { margin: 0; font-family: "Prompt", sans-serif; color: var(--ink); background: #f1f5f9; min-height: 100vh; }
  .wrap { max-width: 1800px; margin: 0 auto; padding: 25px; }

  /* Dashboard Cards */
  .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 25px; }
  .stat-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; border: 1px solid #e2e8f0; }
  .icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; }

  /* Table Style */
  .table-container { background: white; border-radius: 20px; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); overflow: hidden; }
  .table-wrap { overflow: auto; max-height: 65vh; }
  table { width: 100%; border-collapse: collapse; min-width: 1750px; table-layout: fixed; }
  
  /* ‡∏à‡∏±‡∏î‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ù‡∏±‡πà‡∏á */
  th:nth-child(1) { width: 45px; }  /* # */
  th:nth-child(2) { width: 180px; } /* ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ (Sticky) */
  th:nth-child(3) { width: 220px; } /* ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç */
  th:nth-child(4) { width: 140px; } /* ‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô */
  th:nth-child(5) { width: 260px; } /* ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ & ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï */
  th:nth-child(6) { width: 180px; } /* ‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢ */
  th:nth-child(7) { width: 100px; } /* ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó */
  th:nth-child(8) { width: 150px; } /* ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô */
  th:nth-child(9) { width: 150px; } /* ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°) */
  th:nth-child(10){ width: 170px; } /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô */

  thead th { background: #f8fafc; padding: 15px; text-align: left; color: var(--mut); font-weight: 600; font-size: 13px; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #f1f5f9; }
  tbody td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 13.5px; word-wrap: break-word; }

  .sticky-col { position: sticky; left: 0; background: white !important; z-index: 5; font-weight: 700; border-right: 2px solid #f1f5f9; }

  .badge { padding: 6px 12px; border-radius: 8px; font-weight: 700; font-size: 12px; white-space: nowrap; display: inline-block; text-align: center; min-width: 110px; }
  .bg-ok { background: #ecfdf5; color: #059669; }
  .bg-warn { background: #fffbeb; color: #d97706; border: 1px solid #fef3c7; }
  .bg-exp { background: #fef2f2; color: #dc2626; border: 1px solid #fee2e2; }

  .tab-group { display: flex; background: #e2e8f0; padding: 4px; border-radius: 12px; width: fit-content; }
  .tab { padding: 8px 16px; border-radius: 9px; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--mut); transition: 0.2s; }
  .tab.active { background: white; color: var(--dark); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

  .date-main { font-weight: 600; color: var(--dark); }
  .date-sub { font-size: 11px; color: var(--mut); margin-top: 2px; }
</style>
</head>
<body>

<div class="wrap">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
    <h1 style="margin:0; font-size:24px; font-weight:800; color:var(--dark);">üìã Registration Smart Monitor</h1>
    <div style="display:flex; gap:10px;">
      <input id="code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." style="padding:10px; border-radius:10px; border:1px solid #cbd5e1; width:180px;">
      <button id="enterBtn" style="background:var(--dark); color:white; border:none; padding:10px 20px; border-radius:10px; cursor:pointer; font-weight:600;">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </div>

  <div id="statsGrid" class="grid-stats" style="display:none">
    <div class="stat-card">
      <div class="icon" style="background:var(--primary)">‚úì</div>
      <div><div class="mut" style="font-size:11px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div><div id="c-active" style="font-size:24px; font-weight:800">0</div></div>
    </div>
    <div class="stat-card">
      <div class="icon" style="background:var(--warning)">‚è≥</div>
      <div><div class="mut" style="font-size:11px">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (2 ‡∏õ‡∏µ)</div><div id="c-near" style="font-size:24px; font-weight:800">0</div></div>
    </div>
    <div class="stat-card">
      <div class="icon" style="background:var(--danger)">!</div>
      <div><div class="mut" style="font-size:11px">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</div><div id="c-exp" style="font-size:24px; font-weight:800">0</div></div>
    </div>
    <div class="stat-card">
      <div class="icon" style="background:#475569">‚úï</div>
      <div><div class="mut" style="font-size:11px">‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏</div><div id="c-norenew" style="font-size:24px; font-weight:800">0</div></div>
    </div>
  </div>

  <div id="dataSection" style="display:none">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <div class="tab-group">
        <div id="t-active" class="tab active">‡∏¢‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà</div>
        <div id="t-norenew" class="tab">‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</div>
      </div>
      <input id="q" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô, ‡∏û.‡∏®. ..." style="padding:10px; border-radius:10px; border:1px solid #cbd5e1; width:350px;">
    </div>

    <div class="table-container">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th class="sticky-col">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£</th>
              <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
              <th>‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ & ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï</th>
              <th>‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</th>
              <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
              <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
              <th>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://jlrogimfjmtwdqiuyejj.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impscm9naW1mam10d2RxaXV5ZWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDIyODUsImV4cCI6MjA3NTUxODI4NX0.OvX7qgcIF5aCcLebUEUR_6D2KTUP2pALCjRtHWJ5qZg';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  const $ = id => document.getElementById(id);

  let RAW_DATA = [], VIEW = 'ACTIVE';

  function getStatus(exp, isNo) {
    if (isNo) return `<span class="badge" style="color:var(--danger); border:1px solid #fee2e2; background:#fff1f2">‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏</span>`;
    if (!exp) return `<span class="badge bg-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>`;
    const diff = Math.ceil((new Date(exp) - new Date()) / 86400000);
    if (diff < 0) return `<span class="badge bg-exp">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>`;
    if (diff <= 730) {
      const y = Math.floor(diff/365), m = Math.floor((diff%365)/30);
      return `<span class="badge bg-warn">${y > 0 ? y + ' ‡∏õ‡∏µ ' : ''}${m} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>`;
    }
    return `<span class="badge bg-ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>`;
  }

  function render() {
    let rows = RAW_DATA.filter(r => (VIEW === 'ACTIVE' ? !r.renewed_status?.includes('‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠') : r.renewed_status?.includes('‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠')));
    const q = $('q').value.toLowerCase();
    if (q) {
      rows = rows.filter(r => {
        const beYear = r.registration_date ? (new Date(r.registration_date).getFullYear()+543).toString() : '';
        return JSON.stringify(r).toLowerCase().includes(q) || beYear.includes(q);
      });
    }

    $('tbody').innerHTML = rows.map((r, i) => {
      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
      const regDate = r.registration_date ? new Date(r.registration_date) : null;
      const displayRegDate = regDate ? regDate.toLocaleDateString('th-TH', { day:'numeric', month:'short', year:'numeric' }) : '-';
      const yearRegBE = regDate ? `(‡∏û.‡∏®. ${regDate.getFullYear() + 543})` : '';

      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô)
      const expDate = r.expiry_date ? new Date(r.expiry_date) : null;
      const displayExpDate = expDate ? expDate.toLocaleDateString('th-TH', { day:'numeric', month:'short', year:'numeric' }) : '-';
      const yearExpBE = expDate ? `(‡∏û.‡∏®. ${expDate.getFullYear() + 543})` : '';

      return `
        <tr>
          <td style="color:var(--mut)">${i+1}</td>
          <td class="sticky-col">${r.brand_name || '-'}</td>
          <td style="font-size:12px; color:#475569">${r.common_label || '-'}</td>
          <td style="font-weight:500">${r.registration_no || '-'}</td>
          <td>
            <div style="font-weight:600; font-size:12.5px;">${r.importer || '-'}</div>
            <div style="color:var(--mut); font-size:11px; margin-top:2px;">üìç ${r.manufacturer_source || '-'}</div>
          </td>
          <td style="font-weight:600; color:#0369a1">${r.distributor || '-'}</td>
          <td>${r.packed_volume || '-'}</td>
          <td>
            <div class="date-main">${displayRegDate}</div>
            <div class="date-sub">${yearRegBE}</div>
          </td>
          <td>
            <div class="date-main">${displayExpDate}</div>
            <div class="date-sub">${yearExpBE}</div>
          </td>
          <td>${getStatus(r.expiry_date, r.renewed_status?.includes('‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠'))}</td>
        </tr>
      `;
    }).join('');
    updateStats();
  }

  function updateStats() {
    const act = RAW_DATA.filter(r => !r.renewed_status?.includes('‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠')).length;
    const no = RAW_DATA.filter(r => r.renewed_status?.includes('‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠')).length;
    const exp = RAW_DATA.filter(r => r.expiry_date && new Date(r.expiry_date) < new Date() && !r.renewed_status?.includes('‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠')).length;
    const near = RAW_DATA.filter(r => {
      const d = Math.ceil((new Date(r.expiry_date) - new Date()) / 86400000);
      return d >= 0 && d <= 730 && !r.renewed_status?.includes('‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠');
    }).length;

    $('c-active').innerText = act; $('c-norenew').innerText = no; $('c-exp').innerText = exp; $('c-near').innerText = near;
  }

  async function load() {
    const code = $('code').value.trim().toUpperCase();
    if (!code) return;
    const { data } = await sb.rpc('get_company_portal', { p_plain_code: code });
    RAW_DATA = data || [];
    $('statsGrid').style.display = 'grid';
    $('dataSection').style.display = 'block';
    render();
  }

  $('enterBtn').onclick = load;
  $('q').oninput = render;
  $('t-active').onclick = () => { VIEW='ACTIVE'; $('t-active').classList.add('active'); $('t-norenew').classList.remove('active'); render(); };
  $('t-norenew').onclick = () => { VIEW='NORENEW'; $('t-norenew').classList.add('active'); $('t-active').classList.remove('active'); render(); };
</script>
</body>
</html>
