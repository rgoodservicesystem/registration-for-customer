<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Registration Dashboard ‚Äî Perfect Date View</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #f8fafc; --primary: linear-gradient(135deg, #0ea5a5, #14b8a6);
    --danger: #ef4444; --warning: #f59e0b; --ok: #10b981;
    --dark: #0f172a; --ink: #1e293b; --mut: #64748b;
    --pink: #db2777; /* ‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏ */
  }

  body { margin: 0; font-family: "Prompt", sans-serif; color: var(--ink); background: #f1f5f9; min-height: 100vh; }
  .wrap { max-width: 1800px; margin: 0 auto; padding: 25px; }

  /* Dashboard Cards */
  .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 25px; }
  .stat-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; border: 1px solid #e2e8f0; }
  .icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; }

  /* Table Style */
  .table-container { background: white; border-radius: 20px; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); overflow: hidden; }
  .table-wrap { overflow: auto; max-height: 65vh; }
  table { width: 100%; border-collapse: collapse; min-width: 1750px; table-layout: fixed; }
  
  th:nth-child(1) { width: 45px; }
  th:nth-child(2) { width: 180px; }
  th:nth-child(3) { width: 220px; }
  th:nth-child(4) { width: 140px; }
  th:nth-child(5) { width: 260px; }
  th:nth-child(6) { width: 180px; }
  th:nth-child(7) { width: 100px; }
  th:nth-child(8) { width: 150px; }
  th:nth-child(9) { width: 150px; }
  th:nth-child(10){ width: 220px; }

  thead th { background: #f8fafc; padding: 15px; text-align: left; color: var(--mut); font-weight: 600; font-size: 13px; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #f1f5f9; }
  tbody td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 13.5px; word-wrap: break-word; }

  .sticky-col { position: sticky; left: 0; background: white !important; z-index: 5; font-weight: 700; border-right: 2px solid #f1f5f9; }

  .badge { padding: 6px 12px; border-radius: 8px; font-weight: 700; font-size: 12px; white-space: nowrap; display: inline-block; text-align: center; min-width: 110px; }
  .bg-ok { background: #ecfdf5; color: #059669; }
  .bg-warn { background: #fffbeb; color: #d97706; border: 1px solid #fef3c7; }
  .bg-exp { background: #fef2f2; color: #dc2626; border: 1px solid #fee2e2; }

  .tab-group { display: flex; background: #e2e8f0; padding: 4px; border-radius: 12px; width: fit-content; }
  .tab { padding: 8px 16px; border-radius: 9px; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--mut); transition: 0.2s; }
  .tab.active { background: white; color: var(--dark); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  
  /* ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÉ‡∏´‡πâ Tab ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏ */
  #t-done.active { background: var(--pink); color: white; }

  .date-main { font-weight: 600; color: var(--dark); }
  .date-sub { font-size: 11px; color: var(--mut); margin-top: 2px; }

  /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÅ‡∏ö‡∏ö‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô */
  .lang-box {
    display: flex; align-items: center; background: white; border: 2px solid var(--dark); 
    border-radius: 10px; padding: 2px 8px; height: 40px;
  }
  .lang-box select { 
    border: none; outline: none; font-family: "Prompt"; font-weight: 700; cursor: pointer; background: transparent;
  }
/* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Badge ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° */
  .badge { 
    padding: 6px 12px; 
    border-radius: 99px; /* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏£‡∏á‡πÅ‡∏Ñ‡∏õ‡∏ã‡∏π‡∏•‡∏à‡∏∞‡∏î‡∏π‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤ */
    font-weight: 600; 
    font-size: 12px; 
    display: inline-block; 
    text-align: center; 
    min-width: 120px;
    border: 1px solid transparent; 
  }

  .badge { 
    padding: 6px 14px; 
    border-radius: 99px; /* ‡∏ó‡∏£‡∏á‡πÅ‡∏Ñ‡∏õ‡∏ã‡∏π‡∏• */
    font-weight: 700; 
    font-size: 12px; 
    white-space: nowrap; 
    display: inline-block; 
    text-align: center; 
    min-width: 130px; /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏ö‡∏µ‡∏¢‡∏î */
    transition: all 0.2s;
  }
</style>
</head>
<body>

<div class="wrap">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap: wrap; gap: 15px;">
    <h1 style="margin:0; font-size:24px; font-weight:800; color:var(--dark);">üìã Registration Smart Monitor</h1>
    
    <div style="display:flex; gap:10px; align-items: center;">
      <div class="lang-box">
        <span style="font-size: 18px; margin-right: 5px;">üåç</span>
        <select id="langSwitch">
          <option value="th">TH (‡πÑ‡∏ó‡∏¢)</option>
          <option value="en">EN (English)</option>
        </select>
      </div>

      <input id="code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." style="padding:10px; border-radius:10px; border:1px solid #cbd5e1; width:180px; height: 40px; box-sizing: border-box;">
      <button id="enterBtn" style="background:var(--dark); color:white; border:none; padding:0 20px; height: 40px; border-radius:10px; cursor:pointer; font-weight:600;">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </div>

  <div id="statsGrid" class="grid-stats" style="display:none">
    <div class="stat-card">
      <div class="icon" style="background:var(--primary)">‚úì</div>
      <div><div class="mut" style="font-size:11px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div><div id="c-active" style="font-size:24px; font-weight:800">0</div></div>
    </div>
    <div class="stat-card">
      <div class="icon" style="background:var(--warning)">‚è≥</div>
      <div><div class="mut" style="font-size:11px">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (3 ‡∏õ‡∏µ)</div><div id="c-near" style="font-size:24px; font-weight:800">0</div></div>
    </div>
    <div class="stat-card">
      <div class="icon" style="background:var(--danger)">!</div>
      <div><div class="mut" style="font-size:11px">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</div><div id="c-exp" style="font-size:24px; font-weight:800">0</div></div>
    </div>
    <div class="stat-card">
      <div class="icon" style="background:#475569">‚úï</div>
      <div><div class="mut" style="font-size:11px">‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏</div><div id="c-norenew" style="font-size:24px; font-weight:800">0</div></div>
    </div>
  </div>

  <div id="dataSection" style="display:none">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap: wrap; gap: 10px;">
      <div class="tab-group">
        <div id="t-active" class="tab active">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        <div id="t-import" class="tab">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</div>
        <div id="t-pack" class="tab">‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏</div>
        <div id="t-done" class="tab">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏</div> 
        <div id="t-change" class="tab">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï</div> 
        <div id="t-norenew" class="tab">‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏</div>
      </div>
      <input id="q" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô, ‡∏û.‡∏®. ..." style="padding:10px; border-radius:10px; border:1px solid #cbd5e1; width:350px;">
    </div>

    <div class="table-container">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th class="sticky-col">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£</th>
              <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
              <th>‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ & ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï</th>
              <th>‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</th>
              <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
              <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
              <th>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  const i18n = {
    th: {
      title: "üìã ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô",
      search_placeholder: "‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...",
      btn_load: "‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
      stat_active: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£",
      stat_near: "‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (3 ‡∏õ‡∏µ)",
      stat_exp: "‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß",
      stat_norenew: "‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏",
      tabs: ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤", "‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏", "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏", "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï", "‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏"],
      search_table: "üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...",
      cols: ["#", "‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤", "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£", "‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô", "‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ & ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï", "‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö", "‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"]
    },
    en: {
      title: "üìã Registration Smart Monitor",
      search_placeholder: "Customer Code...",
      btn_load: "View Data",
      stat_active: "In Progress",
      stat_near: "Expiring Soon (3Y)",
      stat_exp: "Expired",
      stat_norenew: "No Renewal",
      tabs: ["All", "Imported", "Packed", "Renewing", "Source Change", "No Renewal"],
      search_table: "üîç Search: Brand, Reg No, Year...",
      cols: ["#", "Brand Name", "Common Name", "Reg No.", "Importer & Source", "Distributor", "Type", "Reg. Date", "Expiry Date", "Status"]
    }
  };

  let currentLang = 'th';
  const SUPABASE_URL = 'https://jlrogimfjmtwdqiuyejj.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impscm9naW1mam10d2RxaXV5ZWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDIyODUsImV4cCI6MjA3NTUxODI4NX0.OvX7qgcIF5aCcLebUEUR_6D2KTUP2pALCjRtHWJ5qZg';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  const $ = id => document.getElementById(id);

  let RAW_DATA = [], VIEW = 'ACTIVE';

function getStatus(exp, renewedStatus, lang = 'th') {
    const labels = {
      th: { done: "‚úÖ ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", pending: "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏", change: "üìç ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï", no: "‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏", expired: "‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏", normal: "‡∏õ‡∏Å‡∏ï‡∏¥", left: "‡πÄ‡∏´‡∏•‡∏∑‡∏≠", year: "‡∏õ‡∏µ", month: "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" },
      en: { done: "‚úÖ Completed", pending: "‚è≥ Processing", change: "üìç Source Change", no: "No Renewal", expired: "Expired", normal: "Normal", left: "Remaining", year: "Y", month: "M" }
    };
    const t = labels[lang];

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π ---
    if (renewedStatus === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß') {
      return `<span class="badge" style="background:#fdf2f8; color:var(--pink); border:1px solid #fbcfe8;">${t.done}</span>`;
    }
    if (renewedStatus === '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') {
      // ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡∏π‡πà
      return `<span class="badge" style="background:var(--pink); color:white; border:1px solid #be185d;">${t.pending}</span>`;
    }
    // -------------------------

    if (renewedStatus === '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà') {
      return `<span class="badge" style="background:#eff6ff; color:#1d4ed8; border:1px solid #3b82f6;">${t.change}</span>`;
    }
    if (renewedStatus === '‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏') {
      return `<span class="badge" style="background:#f1f5f9; color:#64748b; border:1px solid #cbd5e1;">${t.no}</span>`;
    }

    if (!exp) return `<span class="badge bg-ok">${t.normal}</span>`;
    
    const now = new Date();
    const eff = new Date(exp);
    const diff = Math.ceil((eff - now) / 86400000);
    
    if (diff < 0) return `<span class="badge bg-exp">${t.expired}</span>`;
    
    if (diff <= 1095) {
      const y = Math.floor(diff/365);
      const m = Math.floor((diff%365)/30);
      let label = y > 0 ? `${t.left} ${y} ${t.year} ${m} ${t.month}` : `${t.left} ${m} ${t.month}`;
      return `<span class="badge bg-warn">${label}</span>`;
    }
    
    return `<span class="badge bg-ok">${t.normal}</span>`;
  }
  function render() {
    let rows = RAW_DATA;

    if (VIEW === 'ACTIVE') rows = rows.filter(r => r.renewed_status !== '‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏');
    else if (VIEW === 'IMPORT') rows = rows.filter(r => r.renewed_status !== '‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏' && r.packed_volume?.includes('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤'));
    else if (VIEW === 'PACK') rows = rows.filter(r => r.renewed_status !== '‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏' && r.packed_volume?.includes('‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏'));
    else if (VIEW === 'DONE') rows = rows.filter(r => r.renewed_status === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß' || r.renewed_status === '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£');
    else if (VIEW === 'CHANGE') rows = rows.filter(r => r.renewed_status === '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà');
    else if (VIEW === 'NORENEW') rows = rows.filter(r => r.renewed_status === '‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏');

    const q = $('q').value.toLowerCase();
    if (q) {
      rows = rows.filter(r => {
        const beYear = r.registration_date ? (new Date(r.registration_date).getFullYear()+543).toString() : '';
        return JSON.stringify(r).toLowerCase().includes(q) || beYear.includes(q);
      });
    }

    $('tbody').innerHTML = rows.map((r, i) => {
      const locale = currentLang === 'th' ? 'th-TH' : 'en-GB';
      const yearOffset = currentLang === 'th' ? 543 : 0;
      const yearLabel = currentLang === 'th' ? '‡∏û.‡∏®.' : 'A.D.';

      const regDate = r.registration_date ? new Date(r.registration_date) : null;
      const displayRegDate = regDate ? regDate.toLocaleDateString(locale, { day:'numeric', month:'short', year:'numeric' }) : '-';
      const yearRegDisplay = regDate ? `(${yearLabel} ${regDate.getFullYear() + yearOffset})` : '';

      const expDate = r.expiry_date ? new Date(r.expiry_date) : null;
      const displayExpDate = expDate ? expDate.toLocaleDateString(locale, { day:'numeric', month:'short', year:'numeric' }) : '-';
      const yearExpDisplay = expDate ? `(${yearLabel} ${expDate.getFullYear() + yearOffset})` : '';

      const statusHtml = getStatus(r.expiry_date, r.renewed_status, currentLang);

      return `
        <tr>
          <td style="color:var(--mut)">${i+1}</td>
          <td class="sticky-col">${r.brand_name || '-'}</td>
          <td style="font-size:12px; color:#475569">${r.common_label || '-'}</td>
          <td style="font-weight:500">${r.registration_no || '-'}</td>
          <td>
            <div style="font-weight:600; font-size:12.5px;">${r.importer || '-'}</div>
            <div style="color:var(--mut); font-size:11px; margin-top:2px;">üìç ${r.manufacturer_source || '-'}</div>
          </td>
          <td style="font-weight:600; color:#0369a1">${r.distributor || '-'}</td>
          <td>${r.packed_volume || '-'}</td>
          <td>
            <div class="date-main">${displayRegDate}</div>
            <div class="date-sub">${yearRegDisplay}</div>
          </td>
          <td>
            <div class="date-main">${displayExpDate}</div>
            <div class="date-sub">${yearExpDisplay}</div>
          </td>
          <td>
            <div>${statusHtml}</div>
            ${ r.renewed_note ? `<div style="color: #64748b; font-size: 11px; margin-top: 6px; padding: 4px 8px; background: #f8fafc; border-radius: 6px; border: 1px dashed #e2e8f0; line-height: 1.4;"><span style="font-weight: 600; color: #0ea5a5;">Note:</span> ${r.renewed_note}</div>` : '' }
          </td>
        </tr>
      `;
    }).join('');
    updateStats();
  }

  function updateStats() {
    const act = RAW_DATA.filter(r => r.renewed_status !== '‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏' && r.renewed_status !== '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß' && r.renewed_status !== '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£').length;
    const no = RAW_DATA.filter(r => r.renewed_status === '‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏').length;
    const exp = RAW_DATA.filter(r => r.expiry_date && new Date(r.expiry_date) < new Date() && r.renewed_status !== '‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏' && r.renewed_status !== '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß' && r.renewed_status !== '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£').length;
    const near = RAW_DATA.filter(r => {
      const d = Math.ceil((new Date(r.expiry_date) - new Date()) / 86400000);
      return d >= 0 && d <= 1095 && r.renewed_status !== '‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏' && r.renewed_status !== '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß' && r.renewed_status !== '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
    }).length;

    $('c-active').innerText = act; 
    $('c-norenew').innerText = no; 
    $('c-exp').innerText = exp; 
    $('c-near').innerText = near;
  }

  async function load() {
    const code = $('code').value.trim().toUpperCase();
    if (!code) return;
    const { data } = await sb.rpc('get_company_portal', { p_plain_code: code });
    RAW_DATA = data || [];
    $('statsGrid').style.display = 'grid';
    $('dataSection').style.display = 'block';
    render();
  }

  $('enterBtn').onclick = load;
  $('q').oninput = render;

  const tabLogic = { 't-active':'ACTIVE', 't-import':'IMPORT', 't-pack':'PACK', 't-done':'DONE', 't-change':'CHANGE', 't-norenew':'NORENEW' };

  Object.keys(tabLogic).forEach(id => {
    const el = $(id);
    if(el) {
      el.onclick = () => {
        VIEW = tabLogic[id];
        Object.keys(tabLogic).forEach(tid => $(tid)?.classList.remove('active'));
        el.classList.add('active');
        render();
      };
    }
  });

  function updateLanguage(lang) {
    currentLang = lang;
    const t = i18n[lang];
    document.querySelector('h1').innerText = t.title;
    $('code').placeholder = t.search_placeholder;
    $('enterBtn').innerText = t.btn_load;
    $('q').placeholder = t.search_table;

    const statLabels = document.querySelectorAll('.stat-card .mut');
    statLabels[0].innerText = t.stat_active;
    statLabels[1].innerText = t.stat_near;
    statLabels[2].innerText = t.stat_exp;
    statLabels[3].innerText = t.stat_norenew;

    const tabIds = ['t-active', 't-import', 't-pack', 't-done', 't-change', 't-norenew'];
    tabIds.forEach((id, i) => { if($(id)) $(id).innerText = t.tabs[i]; });

    const ths = document.querySelectorAll('thead th');
    t.cols.forEach((colName, i) => { if(ths[i]) ths[i].innerText = colName; });

    render();
  }

  $('langSwitch').onchange = (e) => updateLanguage(e.target.value);
</script>
</body>
</html>
