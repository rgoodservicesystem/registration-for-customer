<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Portal ‚Äî ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Import)</title>

<!-- Supabase JS (ESM) -->
<script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
<!-- SheetJS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f6fbff;--card:#fff;--mut:#64748b;--border:#e6eef5;--accent:#0ea5a5;--accent2:#60a5fa}
  body{font-family:"Prompt",sans-serif;background:var(--bg);margin:0;color:#0f172a}
  header{padding:16px;background:linear-gradient(180deg,#f0fbff,#eaf7ff);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:18px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 8px 28px rgba(10,30,60,.06)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,button,textarea{padding:10px;border-radius:10px;border:1px solid var(--border);font-size:14px;background:#fff}
  .btn{cursor:pointer}
  .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;font-weight:700}
  .btn-ghost{background:#fff;border:1px solid #d6eef3;color:#0b6b6b}
  .small{font-size:13px;color:var(--mut)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
  th{background:linear-gradient(180deg,#f7fbff,#f2f8ff);position:sticky;top:0;z-index:1}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:9999}
  .modal-box{background:#fff;padding:16px;border-radius:12px;width:820px;max-width:96%}
  td.editable{cursor:text}
  td.editing{background:#fffbe6}
  .badge{padding:6px 8px;border-radius:999px;font-weight:600;font-size:13px}
  .ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d090}
  .warn{background:#fff7ed;color:#b45309;border:1px solid #fde68a80}
  .exp{background:#fff1f2;color:#b91c1c;border:1px solid #fecaca90}
</style>
</head>
<body>
<header>
  <div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px">
    <div style="font-weight:700">Admin Portal ‚Äî ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
    <div style="flex:1"></div>
    <button id="signOutBtn" class="btn btn-ghost">Sign out</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <label><strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</strong></label>
    <div class="row">
      <select id="companySelect" style="min-width:260px"><option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option></select>
      <div style="flex:1"></div>
      <input id="cust_code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô RG-1234" style="min-width:220px">
      <button id="setCodeBtn" class="btn btn-primary">‡∏ï‡∏±‡πâ‡∏á/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™</button>
      <button id="copyCodeBtn" class="btn btn-ghost">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™</button>
    </div>
    <div id="msg" class="small" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <label><strong>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ / ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å (Preview + Proxy)</strong></label>
    <div class="row">
      <button id="tplBtn" class="btn btn-ghost">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï (.xlsx)</button>

      <!-- file chooser (‡∏ã‡πà‡∏≠‡∏ô) -->
      <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display:none">

      <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î chooser -->
      <button id="chooseFileBtn" class="btn btn-ghost">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå</button>

      <button id="previewBtn" class="btn btn-ghost">Preview</button>
      <button id="impBtn" class="btn btn-primary">Import to Server</button>
      <button id="expBtn" class="btn btn-ghost">Export Excel</button>

      <label style="margin-left:8px"><input type="checkbox" id="replaceMode"> ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ô‡∏µ‡πâ</label>
    </div>
    <div id="previewArea" style="margin-top:12px"></div>
  </div>

  <div class="card">
    <label><strong>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏î‡πà‡∏ß‡∏ô)</strong></label>
    <div class="row" style="align-items:center">
      <input id="brand_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤">
      <input id="common_label" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç+‡∏™‡∏π‡∏ï‡∏£" style="min-width:220px">
      <input id="registration_no" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô">
      <input id="importer" placeholder="‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤">
      <input id="manufacturer_source" placeholder="‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï / ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï">
      <input id="distributor" placeholder="‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢">
      <input id="packed_volume" placeholder="‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏" style="min-width:140px">
      <input id="registration_date" type="date" placeholder="‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô">
      <input id="expiry_date" type="date" placeholder="‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏">
      <button id="addBtn" class="btn btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    </div>
    <div class="small" style="margin-top:8px">* double-click ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö inline</div>
  </div>

  <div class="card"> 
  
  <div class="row" style="margin-bottom:8px">
    <input id="adminSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç / ‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô / ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ..." style="min-width:360px">
    <button id="adminClearBtn" class="btn btn-ghost">‡∏•‡πâ‡∏≤‡∏á</button>
    <div style="flex:1"></div>
    <div id="adminCount" class="small"></div>
  </div>

  <div style="display:flex;gap:8px;margin-bottom:8px">
    <button id="btnSelectAllFiltered" class="btn btn-ghost small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ú‡∏•‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)</button>
    <button id="btnClearSel" class="btn btn-ghost small">‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
    <button id="btnDeleteSel" class="btn btn-danger small">‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
    <div style="flex:1"></div>
    <button id="btnNotePage" class="btn btn-ghost small">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  </div>

  <div style="display:flex;gap:8px;margin-left:8px;margin-bottom:8px">
    <button id="filterAllBtn" class="btn btn-ghost small">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button id="filterRegBtn" class="btn btn-ghost small">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
    <button id="filterImportBtn" class="btn btn-ghost small">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤"</button>
    <button id="filterPackBtn" class="btn btn-ghost small">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏"</button>
  </div>
  
  <div style="overflow-y: auto; max-height: 58vh;"> <table>
      <thead>
        <tr>
          <th style="width:36px"><input id="chkAllVisible" type="checkbox"></th>
          <th>#</th>
          <th>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç+‡∏™‡∏π‡∏ï‡∏£</th>
          <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
          <th>‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</th>
          <th>‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï/‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï</th>
          <th>‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</th>
          <th>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏</th>
          <th>‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
          <th>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td colspan="14" class="small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</td></tr></tbody>
    </table>
  </div>
</div>

<!-- note modal -->
<div id="noteModal" class="modal"><div class="modal-box"><div style="display:flex;justify-content:space-between;align-items:center">
  <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</strong><button id="closeNote" class="btn btn-ghost">‡∏õ‡∏¥‡∏î</button></div>
  <textarea id="noteText" style="width:100%;min-height:140px;margin-top:8px"></textarea>
  <div style="display:flex;justify-content:flex-end;margin-top:8px"><button id="saveNote" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
</div></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// ================= CONFIG (‡πÅ‡∏Å‡πâ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô) =================
const SUPABASE_URL = 'https://jlrogimfjmtwdqiuyejj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impscm9naW1mam10d2RxaXV5ZWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDIyODUsImV4cCI6MjA3NTUxODI4NX0.OvX7qgcIF5aCcLebUEUR_6D2KTUP2pALCjRtHWJ5qZg';
const LEGACY_ADMIN_KEY = 'PPHASIN2556'; // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ

const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// tables
const COMPANIES_TABLE = 'companies';
const REG_TABLE = 'product_registrations';

// =============== Helpers ===============
const $ = id => document.getElementById(id);
const WARNING_DAYS = 90;
let currentCompany = '';
let cachedRows = [];
let filteredRows = [];
const selectedIds = new Set();
let editingNoteId = null;

function esc(s){ return String(s||'').replace(/[&<>'"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\\' : '&#39;', '"':'&quot;'}[m]) ); }
function fmtDateBE(d){ if(!d) return ''; const t=new Date(d); if(isNaN(t)) return ''; try{ return t.toLocaleDateString('th-TH-u-ca-buddhist',{year:'numeric',month:'short',day:'numeric', timeZone:'Asia/Bangkok'}); }catch(e){ return t.toISOString().split('T')[0];} }
function toISO(d){ if(!d) return ''; const t=new Date(d); return isNaN(t)?'':t.toISOString().slice(0,10); }
function toast(m, ok=true){ $('msg').textContent = m; $('msg').style.color = ok ? '#065f46' : '#b91c1c'; setTimeout(()=>{$('msg').textContent='';}, 3500); }

// =============== Load companies ===============
async function loadCompanies(){
  const sel = $('companySelect');
  sel.innerHTML = `<option value="">‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‚Äî</option>`;
  try{
    const { data, error } = await sb.from(COMPANIES_TABLE).select('code,name').order('code',{ascending:true});
    if(error) throw error;
    const rows = data || [];
    sel.innerHTML = `<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‚Äî</option>` + rows.map(c=>`<option value="${esc(c.code)}">${esc(c.code)}${c.name? ' - '+esc(c.name):''}</option>`).join('');
  }catch(e){ console.error(e); sel.innerHTML = `<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>`; }
}

// =============== Load registrations ===============
async function loadDocs(code){
  currentCompany = code;
  selectedIds.clear();
  $('cust_code').value = '';
  if(!code){ $('tbody').innerHTML = `<tr><td colspan="14" class="small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</td></tr>`; $('adminCount').textContent=''; return; }
  try{
    const { data, error } = await sb.from(REG_TABLE).select('*').eq('company_code', code).order('id',{ascending:true});
    if(error) throw error;
    cachedRows = (data||[]).map(r=>({ ...r, ...classify(r.expiry_date) }));
    filteredRows = [...cachedRows];
    renderTable();
    // load plain_code
    const { data: comp } = await sb.from(COMPANIES_TABLE).select('plain_code').eq('code', code).limit(1).single();
    if(comp) $('cust_code').value = comp.plain_code || '';
  }catch(e){ console.error(e); $('tbody').innerHTML = `<tr><td colspan="14" class="small">${esc(e.message)}</td></tr>`; }
}

// =============== classify ===============
function classify(expiry){
  if(!expiry) return { cls:'', badge:`<span class="badge ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>`, order:3, statusText:'‡∏õ‡∏Å‡∏ï‡∏¥' };
  const eff = new Date(expiry);
  if(isNaN(eff)) return { cls:'', badge:`<span class="badge ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>`, order:3, statusText:'‡∏õ‡∏Å‡∏ï‡∏¥' };
  const diff = Math.ceil((eff - new Date())/86400000);
  if(diff < 0) return { cls:'expired', badge:`<span class="badge exp">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>`, order:1, statusText:'‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' };
  if(diff <= WARNING_DAYS) return { cls:'warning', badge:`<span class="badge warn">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${diff} ‡∏ß‡∏±‡∏ô</span>`, order:2, statusText:`‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${diff} ‡∏ß‡∏±‡∏ô` };
  return { cls:'', badge:`<span class="badge ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>`, order:3, statusText:'‡∏õ‡∏Å‡∏ï‡∏¥' };
}

// =============== render ===============
function renderTable(q=''){
  const tb = $('tbody');
  if(!filteredRows.length){ tb.innerHTML = `<tr><td colspan="14" class="small">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`; $('adminCount').textContent = ''; return; }
  tb.innerHTML = filteredRows.map((r,i)=>`
    <tr class="${r.cls}">
      <td><input type="checkbox" class="rowchk" data-id="${esc(r.id)}" ${selectedIds.has(r.id)?'checked':''}></td>
      <td>${i+1}</td>
      <td>${esc(r.company_code||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="brand_name">${esc(r.brand_name||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="common_label">${esc(r.common_label||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="registration_no">${esc(r.registration_no||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="importer">${esc(r.importer||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="manufacturer_source">${esc(r.manufacturer_source||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="distributor">${esc(r.distributor||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="packed_volume">${esc(r.packed_volume||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="registration_date" data-raw="${esc(toISO(r.registration_date)||'')}">${r.registration_date?fmtDateBE(r.registration_date):''}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="expiry_date" data-raw="${esc(toISO(r.expiry_date)||'')}">${r.expiry_date?fmtDateBE(r.expiry_date):''}</td>
      <td>${r.badge}</td>
      <td style="white-space:nowrap">
        <button class="btn btn-ghost" onclick="openNote('${esc(r.id)}')">üìù</button>
        <button class="btn btn-ghost" onclick="setStatus('${esc(r.id)}','‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')">‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á</button>
        <button class="btn btn-primary" onclick="setStatus('${esc(r.id)}','‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß')">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</button>
        <button class="btn btn-ghost" onclick="delDoc('${esc(r.id)}')">‡∏•‡∏ö</button>
      </td>
    </tr>
  `).join('');

  document.querySelectorAll('.rowchk').forEach(chk=>{
    chk.addEventListener('change', (e)=>{
      const id = e.target.dataset.id;
      if(e.target.checked) selectedIds.add(id); else selectedIds.delete(id);
      $('adminCount').textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${selectedIds.size} / ‡πÅ‡∏™‡∏î‡∏á ${filteredRows.length} / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${cachedRows.length}`;
    });
  });

  $('adminCount').textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${selectedIds.size} / ‡πÅ‡∏™‡∏î‡∏á ${filteredRows.length} / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${cachedRows.length}`;
  $('chkAllVisible').checked = filteredRows.length>0 && filteredRows.every(r=>selectedIds.has(r.id));
}

// =============== filter logic ===============
function applyFilter(){
  const q = ($('adminSearch').value||'').trim().toLowerCase();
  if(!q){ filteredRows = [...cachedRows]; renderTable(); return; }
  const toks = q.split(/\s+/).filter(Boolean);
  filteredRows = cachedRows.filter(r=>{
    const hay = [r.brand_name,r.common_label,r.registration_no,r.importer,r.manufacturer_source,r.distributor,r.packed_volume].join(' ').toLowerCase();
    return toks.every(t => hay.includes(t));
  });
  renderTable(q);
}

// ===== filter buttons: reg/import/pack =====
$('filterAllBtn').addEventListener('click', ()=>{ filteredRows = [...cachedRows]; renderTable(); });
$('filterRegBtn').addEventListener('click', ()=>{ filteredRows = cachedRows.filter(r => r.registration_no && r.registration_no.trim() !== ''); renderTable(); });
$('filterImportBtn').addEventListener('click', ()=>{ filteredRows = cachedRows.filter(r => { const pv = String(r.packed_volume||'').toLowerCase(); const imp = String(r.importer||'').toLowerCase(); return pv.includes('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤') || imp.includes('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤') || pv.includes('import') || imp.includes('import'); }); renderTable(); });
$('filterPackBtn').addEventListener('click', ()=>{ filteredRows = cachedRows.filter(r => { const pv = String(r.packed_volume||'').toLowerCase(); return pv.includes('‡πÅ‡∏ö‡πà‡∏á') || pv.includes('‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏') || pv.includes('repack') || pv.includes('‡πÅ‡∏ö‡πà‡∏á '); }); renderTable(); });

// =============== add new ===============
$('addBtn').addEventListener('click', async ()=>{ 
  if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô');
  const payload = {
    company_code: currentCompany,
    brand_name: $('brand_name').value.trim(),
    common_label: $('common_label').value.trim(),
    registration_no: $('registration_no').value.trim() || null,
    importer: $('importer').value.trim() || null,
    manufacturer_source: $('manufacturer_source').value.trim() || null,
    distributor: $('distributor').value.trim() || null,
    packed_volume: $('packed_volume').value.trim() || null,
    registration_date: $('registration_date').value || null,
    expiry_date: $('expiry_date').value || null
  };
  if(!payload.brand_name || !payload.common_label) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£');
  try{
    const { error } = await sb.from(REG_TABLE).insert(payload);
    if(error) throw error;
    ['brand_name','common_label','registration_no','importer','manufacturer_source','distributor','packed_volume','registration_date','expiry_date'].forEach(id=>{ if($(id)) $(id).value=''; });
    loadDocs(currentCompany);
  }catch(e){ alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});

// =============== inline edit ===============
(function initInlineEdit(){
  const tb = $('tbody');
  tb.addEventListener('dblclick', (e)=>{
    const td = e.target.closest('td.editable');
    if(!td) return;
    if(td.classList.contains('editing')) return;
    td.classList.add('editing');
    const id = td.dataset.id;
    const field = td.dataset.field;
    const old = td.getAttribute('data-raw') || td.textContent.trim();
    const input = document.createElement('input');
    input.style.width = '100%';
    if(field.includes('date')){ input.type='date'; input.value = td.getAttribute('data-raw') || ''; }
    else input.value = td.textContent.trim();
    td.innerHTML = ''; td.appendChild(input); input.focus();
    const finish = async (commit)=>{
      td.classList.remove('editing');
      if(!commit){ td.innerHTML = field.includes('date') ? (td.getAttribute('data-raw')?fmtDateBE(td.getAttribute('data-raw')):'') : esc(old); return; }
      const payload = {}; payload[field] = field.includes('date') ? (input.value||null) : (input.value.trim()||null);
      try{
        const { error } = await sb.from(REG_TABLE).update(payload).eq('id', id);
        if(error) throw error;
        loadDocs(currentCompany);
      }catch(e){ alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); td.innerHTML = esc(old); }
    };
    input.addEventListener('keydown', ev=>{ if(ev.key==='Enter'){ ev.preventDefault(); finish(true);} if(ev.key==='Escape'){ finish(false); }});
    input.addEventListener('blur', ()=> finish(true));
  });
})();

// =============== notes / status / delete ===============
window.openNote = (id)=>{
  editingNoteId = id;
  const row = cachedRows.find(r=>r.id==id);
  $('noteText').value = row?.renewed_note || '';
  $('noteModal').style.display = 'flex';
};
$('closeNote').addEventListener('click', ()=> $('noteModal').style.display='none');
$('saveNote').addEventListener('click', async ()=>{
  if(!editingNoteId) return;
  try{
    const { error } = await sb.from(REG_TABLE).update({ renewed_note: $('noteText').value }).eq('id', editingNoteId);
    if(error) throw error;
    $('noteModal').style.display='none';
    loadDocs(currentCompany);
  }catch(e){ alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});

window.setStatus = async function(id, statusText){
  try{
    const { error } = await sb.from(REG_TABLE).update({ renewed_status: statusText, renewed_on: new Date().toISOString() }).eq('id', id);
    if(error) throw error;
    loadDocs(currentCompany);
  }catch(e){ alert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
};

window.delDoc = async function(id){
  if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  try{
    const { error } = await sb.from(REG_TABLE).delete().eq('id', id);
    if(error) throw error;
    loadDocs(currentCompany);
  }catch(e){ alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
};

// bulk delete
$('btnDeleteSel').addEventListener('click', async ()=>{
  if(selectedIds.size===0) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô');
  if(!confirm(`‡∏•‡∏ö ${selectedIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) return;
  try{
    const ids = Array.from(selectedIds).map(x=>Number(x));
    const { error } = await sb.from(REG_TABLE).delete().in('id', ids);
    if(error) throw error;
    selectedIds.clear(); loadDocs(currentCompany);
  }catch(e){ alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});

// =============== set customer code RPC-like ===============
$('setCodeBtn').addEventListener('click', async ()=>{
  if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó');
  const code = $('cust_code').value.trim(); if(!code) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™');
  try{
    const { error } = await sb.from(COMPANIES_TABLE).upsert({ code: currentCompany, plain_code: code }, { onConflict: 'code' });
    if(error) throw error;
    toast('‡∏ï‡∏±‡πâ‡∏á/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    loadCompanies();
  }catch(e){ alert('‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});
$('copyCodeBtn').addEventListener('click', async ()=>{ const code = $('cust_code').value.trim(); if(!code) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™'); await navigator.clipboard.writeText(code); alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'); });

// =============== template, preview, import, export ===============
$('tplBtn').addEventListener('click', ()=>{
  const headers = ['brand_name','common_label','registration_no','importer','manufacturer_source','distributor','packed_volume','registration_date','expiry_date','license_no'];
  const example = ['‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á','‡∏™‡∏π‡∏ï‡∏£X','REG-001','‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤','‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï X','‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢ Y','‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ 500 ‡∏°‡∏•.','2024-01-01','2026-01-01','LIC-001'];
  const aoa = [headers, example];
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'template');
  XLSX.writeFile(wb, 'template_registrations.xlsx');
});

$('chooseFileBtn').addEventListener('click', ()=> $('fileInput').click());

$('previewBtn').addEventListener('click', async ()=>{
  const f = $('fileInput').files[0]; if(!f) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô preview');
  try{
    const ab = await f.arrayBuffer();
    const wb = XLSX.read(ab, { type:'array', raw:true }); // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏° raw: true
const ws = wb.Sheets[wb.SheetNames[0]];
// ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ header: 1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô Array of Arrays ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Preview
const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:'', raw:true }); 
// ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ { header: 1 } ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö preview
    const table = document.createElement('table'); table.style.width='100%'; table.border=1;
    rows.slice(0,11).forEach((r)=>{ const tr = table.insertRow(); r.forEach(c=>{ const td = tr.insertCell(); td.textContent = c; }); });
    const pa = $('previewArea'); pa.innerHTML=''; pa.appendChild(table);
    pa.insertAdjacentHTML('afterbegin', `<div class="small">Preview: ‡πÅ‡∏ñ‡∏ß‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡πÅ‡∏ñ‡∏ß ‚Äî ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏Å‡∏î Import to Server</div>`);
  }catch(e){ alert('Preview ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});

// normalize date
function normalizeDate(v){
  if(!v && v !== 0) return null;
  if(v instanceof Date && !isNaN(v)) return v.toISOString().slice(0,10);
  if(typeof v === 'number' && isFinite(v)){
  const epoch = new Date(Math.round((v - 25569) * 86400 * 1000));
  return epoch.toISOString().slice(0,10);
}
  if(typeof v === 'string'){
    let s = v.trim().replace(/\./g,'/').replace(/\s+/g,'');
    const thnums = {'‡πê':'0','‡πë':'1','‡πí':'2','‡πì':'3','‡πî':'4','‡πï':'5','‡πñ':'6','‡πó':'7','‡πò':'8','‡πô':'9'};
    s = s.replace(/[‡πê-‡πô]/g, ch => thnums[ch] ?? ch);
    let m = s.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/);
    if(m) return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
    m = s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})$/);
    if(m){
      let d = parseInt(m[1],10), mo = parseInt(m[2],10), y = parseInt(m[3],10);
      if(y < 100) y += (y >= 70 ? 1900 : 2000);
      if(y > 2400) y -= 543;
      return `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    }
    return null;
  }
  return null;
}

function pick(obj, keys){
  for(const k of keys){
    for(const kk in obj){
      if(kk.trim().toLowerCase() === k) return obj[kk];
    }
  }
  return '';
}

// import (client-side to Supabase)
$('impBtn').addEventListener('click', async ()=>{
  const f = $('fileInput').files[0]; if(!f) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô import'); if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤');
  if($('replaceMode').checked && !confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  try{
    const ab = await f.arrayBuffer();
    const wb = XLSX.read(ab, { type:'array', raw:true }); // <--- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
const ws = wb.Sheets[wb.SheetNames[0]];
// ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô JSON (Array of Objects) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Import
const rows = XLSX.utils.sheet_to_json(ws, { defval:'', raw:true }); // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏° raw: true

    const mapped = rows.map(r=>{
      const brand = pick(r, ['brand_name','‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤','brand']);
      const common = pick(r, ['common_label','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç','‡∏™‡∏π‡∏ï‡∏£']);
      const regno = pick(r, ['registration_no','‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô','registration']);
      const importer = pick(r, ['importer','‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤']);
      const manu = pick(r, ['manufacturer_source','‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï','‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï']);
      const distrib = pick(r, ['distributor','‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢']);
      const packed = pick(r, ['packed_volume','‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏','packed_volume']);
      const regdate = pick(r, ['registration_date','‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô']);
      const exp = pick(r, ['expiry_date','‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏','‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏¥‡∏°','expiry_date']);
      const lic = pick(r, ['license_no','‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï','license_no']);

      const registration_date = normalizeDate(regdate);
      const expiry_date = normalizeDate(exp);

      return {
        company_code: currentCompany,
        brand_name: String(brand||'').trim(),
        common_label: String(common||'').trim(),
        registration_no: String(regno||'').trim() || null,
        importer: String(importer||'').trim() || null,
        manufacturer_source: String(manu||'').trim() || null,
        distributor: String(distrib||'').trim() || null,
        packed_volume: String(packed||'').trim() || null,
        registration_date: registration_date || null,
        expiry_date: expiry_date || null,
        license_no: String(lic||'').trim() || null
      };
    }).filter(x => x.brand_name && x.common_label);

    if(mapped.length === 0) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ + ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£)');

    if($('replaceMode').checked){
      const del = await sb.from(REG_TABLE).delete().eq('company_code', currentCompany);
      if(del.error) throw del.error;
    }

    for(let i=0;i<mapped.length;i+=500){
      const chunk = mapped.slice(i,i+500);
      const { error } = await sb.from(REG_TABLE).insert(chunk);
      if(error) throw error;
    }

    toast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${mapped.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    loadDocs(currentCompany);
  }catch(err){
    console.error('IMPORT ERROR', err);
    alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err?.message || err));
  }
});

// export xlsx
$('expBtn').addEventListener('click', async ()=>{
  if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
  try{
    const rows = cachedRows || [];
    const aoa = [['‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó','‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£','‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô','‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤','‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï/‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï','‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢','‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏','‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô','‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏','‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']];
    rows.forEach(r=> aoa.push([r.company_code||'', r.brand_name||'', r.common_label||'', r.registration_no||'', r.importer||'', r.manufacturer_source||'', r.distributor||'', r.packed_volume||'', r.registration_date?toISO(r.registration_date):'', r.expiry_date?toISO(r.expiry_date):'', r.license_no||'', r.statusText||'' ]));
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, currentCompany.slice(0,31)); XLSX.writeFile(wb, `registrations_${currentCompany}.xlsx`);
  }catch(e){ alert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});

// =============== misc events ===============
$('fileInput').addEventListener('change', ()=> $('previewBtn').click());
$('companySelect').addEventListener('change', e=> { if(e.target.value) loadDocs(e.target.value); });
$('adminSearch').addEventListener('input', ()=> applyFilter());
$('adminClearBtn').addEventListener('click', ()=> { $('adminSearch').value=''; applyFilter(); });
$('btnSelectAllFiltered').addEventListener('click', ()=> filteredRows.forEach(r=> selectedIds.add(r.id)) || renderTable());
$('btnClearSel').addEventListener('click', ()=> selectedIds.clear() || renderTable());
$('signOutBtn').addEventListener('click', async ()=> { await sb.auth.signOut(); sessionStorage.removeItem('legacy_admin_key'); location.href = '/admin_login.html'; });

// start
document.addEventListener('DOMContentLoaded', async ()=>{
  // legacy key auto-login for dev
  if(LEGACY_ADMIN_KEY && LEGACY_ADMIN_KEY !== 'PUT_ADMIN_KEY_HERE') sessionStorage.setItem('legacy_admin_key', LEGACY_ADMIN_KEY);
  try{
    const { data: { session } } = await sb.auth.getSession();
    // if no session and no legacy key, you can still load companies if anon has rights
  }catch(e){ console.error(e); }
  await loadCompanies();
});

// expose some for console
window.openNote = openNote;
window.setStatus = setStatus;
window.delDoc = delDoc;
window.loadDocs = loadDocs;
window.applyFilter = applyFilter;
window.loadCompanies = loadCompanies;

</script>
</body>
</html>
