<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Portal ‚Äî ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Import)</title>

<script type="module" src="https://esm.sh/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f6fbff;--card:#fff;--mut:#64748b;--border:#e6eef5;--accent:#0ea5a5;--accent2:#60a5fa}
  body{font-family:"Prompt",sans-serif;background:var(--bg);margin:0;color:#0f172a}
  header{padding:16px;background:linear-gradient(180deg,#f0fbff,#eaf7ff);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:18px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 8px 28px rgba(10,30,60,.06)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,button,textarea{padding:10px;border-radius:10px;border:1px solid var(--border);font-size:14px;background:#fff}
  .btn{cursor:pointer}
  .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;font-weight:700}
  .btn-ghost{background:#fff;border:1px solid #d6eef3;color:#0b6b6b}
  .small{font-size:13px;color:var(--mut)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
  th{background:linear-gradient(180deg,#f7fbff,#f2f8ff);position:sticky;top:0;z-index:1}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:9999}
  .modal-box{background:#fff;padding:16px;border-radius:12px;width:820px;max-width:96%}
  td.editable{cursor:text}
  td.editing{background:#fffbe6}
  .badge{padding:6px 8px;border-radius:999px;font-weight:600;font-size:13px}
  .ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d090}
  .warn{background:#fff7ed;color:#b45309;border:1px solid #fde68a80}
  .exp{background:#fff1f2;color:#b91c1c;border:1px solid #fecaca90}
/* --- ‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ä‡∏µ‡πâ (Hover Effect) --- */
  tbody tr {
    transition: background-color 0.15s ease; /* ‡πÉ‡∏´‡πâ‡∏™‡∏µ‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏• */
  }
  tbody tr:hover {
    background-color: #e0f2fe; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
    cursor: pointer;           /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠ */
  }
  
  /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ: ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (editing) ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ */
  tbody tr:hover td.editing {
    background-color: #fffbe6;
    cursor: text;
  }
  /* --- ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô (Status Colors) --- */
  
  /* ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß -> ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡∏ô‡∏ï‡πå */
  tr.st-done { background-color: #d1fae5 !important; }
  
  /* ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ -> ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏≠‡πà‡∏≠‡∏ô */
  tr.st-process { background-color: #ffedd5 !important; }

  /* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏ï‡∏≠‡∏ô Hover ‡∏Ç‡∏≠‡∏á‡∏û‡∏ß‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ä‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà */
  tr.st-done:hover { background-color: #a7f3d0 !important; }
  tr.st-process:hover { background-color: #fed7aa !important; }
  /* --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà (‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏™‡∏î‡πÉ‡∏™) --- */
  tr.st-change { background-color: #cffafe !important; } 
  tr.st-change:hover { background-color: #a5f3fc !important; }
  /* --- ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏° (‡πÄ‡∏ô‡πâ‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤) --- */
  
  /* 1. ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Badge) */
  .badge {
    font-size: 13px !important;    /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏±‡∏î */
    padding: 4px 8px !important;   /* ‡∏Ç‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏´‡∏ô‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
    white-space: nowrap;           /* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
    vertical-align: middle;
    border-radius: 6px;            /* ‡∏°‡∏∏‡∏°‡∏°‡∏ô‡∏ô‡∏¥‡∏î‡πÜ */
    font-weight: 600;              /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤‡∏û‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì */
    border: 1px solid transparent; /* ‡∏à‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö */
  }

  /* 2. ‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà" */
  .change {
    color: #9d174d !important;        
    background: #fce7f3 !important;   
    border: 1px solid #f472b6 !important; /* ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡∏ä‡∏±‡∏î‡πÜ */
  }

  /* 3. ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Admin) */
  .btn.small, .btn-ghost.small {
    font-size: 13px !important;    /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏° */
    padding: 4px 8px !important;   /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏î‡πÉ‡∏´‡πâ‡∏à‡∏¥‡πâ‡∏°‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
    height: auto;
  }

</style>
</head>
<body>
<header>
  <div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px">
    <div style="font-weight:700">Admin Portal ‚Äî ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Import)</div>
    <div style="flex:1"></div>
    <button id="signOutBtn" class="btn btn-ghost">Sign out</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <label><strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</strong></label>
    <div class="row">
      <select id="companySelect" style="min-width:260px"><option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option></select>
      <div style="flex:1"></div>
      <input id="cust_code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô RG-1234" style="min-width:220px">
      <button id="setCodeBtn" class="btn btn-primary">‡∏ï‡∏±‡πâ‡∏á/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™</button>
      <button id="copyCodeBtn" class="btn btn-ghost">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™</button>
    </div>
    <div id="msg" class="small" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <label><strong>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ / ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å (Preview + Proxy)</strong></label>
    <div class="row">
      <button id="tplBtn" class="btn btn-ghost">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï (.xlsx)</button>

      <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display:none">

      <button id="chooseFileBtn" class="btn btn-ghost">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå</button>

      <button id="previewBtn" class="btn btn-ghost">Preview</button>
      <button id="impBtn" class="btn btn-primary">Import to Server</button>
      <button id="expBtn" class="btn btn-ghost">Export Excel</button>

      <label style="margin-left:8px"><input type="checkbox" id="replaceMode"> ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ô‡∏µ‡πâ</label>
    </div>
    <div id="previewArea" style="margin-top:12px"></div>
  </div>

  <div class="card">
    <label><strong>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏î‡πà‡∏ß‡∏ô)</strong></label>
    <div class="row" style="align-items:center">
      <input id="brand_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤">
      <input id="common_label" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç+‡∏™‡∏π‡∏ï‡∏£" style="min-width:220px">
      <input id="registration_no" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô">
      <input id="importer" placeholder="‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤">
      <input id="manufacturer_source" placeholder="‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï / ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï">
      <input id="distributor" placeholder="‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢">
      <input id="packed_volume" placeholder="‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏" style="min-width:140px">
      <input id="registration_date" type="date" placeholder="‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô">
      <input id="expiry_date" type="date" placeholder="‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏">
      <button id="addBtn" class="btn btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    </div>
    <div class="small" style="margin-top:8px">* double-click ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö inline</div>
  </div>
   <div class="card"> 
  
  <div class="row" style="margin-bottom:8px">
<div style="display:flex; align-items:center; gap:8px; margin-bottom:8px">
  <span class="small" style="font-weight:700">‡∏õ‡∏µ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏û.‡∏®.):</span>
  <select id="yearFilter" style="width:120px; border-color:var(--accent)">
    <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
    <option value="2025">2568</option>
    <option value="2026">2569</option>
    <option value="2024">2567</option>
  </select>
  
  <input id="adminSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç / ‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô / ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ..." style="min-width:360px">
  <button id="adminClearBtn" class="btn btn-ghost">‡∏•‡πâ‡∏≤‡∏á</button>
  <div style="flex:1"></div>
  <div id="adminCount" class="small"></div>
</div>
    
  <div style="display:flex;gap:8px;margin-bottom:8px">
    <button id="btnSelectAllFiltered" class="btn btn-ghost small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ú‡∏•‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)</button>
    <button id="btnClearSel" class="btn btn-ghost small">‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
    <button id="btnDeleteSel" class="btn btn-danger small">‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
    <div style="flex:1"></div>
    <button id="btnNotePage" class="btn btn-ghost small">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  </div>

  <div style="display:flex;gap:8px;margin-left:8px;margin-bottom:8px">
    <button id="filterAllBtn" class="btn btn-ghost small">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button id="filterRegBtn" class="btn btn-ghost small">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
    <button id="filterImportBtn" class="btn btn-ghost small">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤"</button>
    <button id="filterPackBtn" class="btn btn-ghost small">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏"</button>
<button id="filterActiveBtn" class="btn btn-primary small">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡∏π‡πà</button>
    <button id="filterCancelBtn" class="btn btn-ghost small">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏</button>
    <button id="filterAllBtn" class="btn btn-ghost small">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  </div>
  
  <div style="overflow-y: auto; max-height: 58vh;"> <table>
      <thead>
        <tr>
          <th style="width:36px"><input id="chkAllVisible" type="checkbox"></th>
          <th>#</th>
          <th>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç+‡∏™‡∏π‡∏ï‡∏£</th>
          <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
          <th>‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</th>
          <th>‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï/‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï</th>
          <th>‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</th>
          <th>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏</th>
          <th>‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
          <th>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td colspan="14" class="small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</td></tr></tbody>
    </table>
  </div>
</div>

<div id="noteModal" class="modal"><div class="modal-box"><div style="display:flex;justify-content:space-between;align-items:center">
  <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</strong><button id="closeNote" class="btn btn-ghost">‡∏õ‡∏¥‡∏î</button></div>
  <textarea id="noteText" style="width:100%;min-height:140px;margin-top:8px"></textarea>
  <div style="display:flex;justify-content:flex-end;margin-top:8px"><button id="saveNote" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
</div></div>

<script type="module">
// --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå esm.sh ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£ ---
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

// ================= CONFIG (‡πÅ‡∏Å‡πâ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô) =================
const SUPABASE_URL = 'https://jlrogimfjmtwdqiuyejj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impscm9naW1mam10d2RxaXV5ZWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDIyODUsImV4cCI6MjA3NTUxODI4NX0.OvX7qgcIF5aCcLebUEUR_6D2KTUP2pALCjRtHWJ5qZg';
const LEGACY_ADMIN_KEY = 'PPHASIN2556'; // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ

const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// tables
const COMPANIES_TABLE = 'companies';
const REG_TABLE = 'product_registrations';

// =============== Helpers ===============
const $ = id => document.getElementById(id);
// ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 2 ‡∏õ‡∏µ
const WARNING_DAYS = 365 * 2; // = 730 ‡∏ß‡∏±‡∏ô
let currentCompany = '';
let cachedRows = [];
let filteredRows = [];
const selectedIds = new Set();
let editingNoteId = null;

function esc(s){ return String(s||'').replace(/[&<>'"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\\' : '&#39;', '"':'&quot;'}[m]) ); }
function fmtDateBE(d){ if(!d) return ''; const t=new Date(d); if(isNaN(t)) return ''; try{ return t.toLocaleDateString('th-TH-u-ca-buddhist',{year:'numeric',month:'short',day:'numeric', timeZone:'Asia/Bangkok'}); }catch(e){ return t.toISOString().split('T')[0];} }
function toISO(d){ if(!d) return ''; const t=new Date(d); return isNaN(t)?'':t.toISOString().slice(0,10); }
function toast(m, ok=true){ $('msg').textContent = m; $('msg').style.color = ok ? '#065f46' : '#b91c1c'; setTimeout(()=>{$('msg').textContent='';}, 3500); }

// =============== Load companies ===============
async function loadCompanies(){
  const sel = $('companySelect');
  sel.innerHTML = `<option value="">‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‚Äî</option>`;
  try{
    const { data, error } = await sb.from(COMPANIES_TABLE).select('code,name').order('code',{ascending:true});
    if(error) throw error;
    const rows = data || [];
    sel.innerHTML = `<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‚Äî</option>` + rows.map(c=>`<option value="${esc(c.code)}">${esc(c.code)}${c.name? ' - '+esc(c.name):''}</option>`).join('');
  }catch(e){ console.error(e); sel.innerHTML = `<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>`; }
}

// =============== Load registrations ===============
async function loadDocs(code){
  currentCompany = code;
  selectedIds.clear();
  $('cust_code').value = '';
  if(!code){ $('tbody').innerHTML = `<tr><td colspan="14" class="small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</td></tr>`; $('adminCount').textContent=''; return; }
  try{
    const { data, error } = await sb.from(REG_TABLE).select('*').eq('company_code', code).order('id',{ascending:true});
    if(error) throw error;
    cachedRows = (data||[]).map(r=>({ ...r, ...classify(r.expiry_date) }));
    filteredRows = [...cachedRows];
    renderTable();
    // load plain_code
    const { data: comp } = await sb.from(COMPANIES_TABLE).select('plain_code').eq('code', code).limit(1).single();
    if(comp) $('cust_code').value = comp.plain_code || '';
  }catch(e){ console.error(e); $('tbody').innerHTML = `<tr><td colspan="14" class="small">${esc(e.message)}</td></tr>`; }
}

// ================= ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏ö‡∏ö ‡∏õ‡∏µ/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏ß‡∏±‡∏ô =================
function classify(expiry) {
    if (!expiry) return { cls: '', badge: `<span class="badge ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>`, order: 3, statusText: '‡∏õ‡∏Å‡∏ï‡∏¥' };

    const now = new Date();
    const eff = new Date(expiry);

    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πä‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô
    now.setHours(0, 0, 0, 0);
    eff.setHours(0, 0, 0, 0);

    if (isNaN(eff)) return { cls: '', badge: `<span class="badge ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>`, order: 3, statusText: '‡∏õ‡∏Å‡∏ï‡∏¥' };

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô "‡∏ß‡∏±‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏/‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    const diffTime = eff.getTime() - now.getTime();
    const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    // 1. ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß
    if (totalDays < 0) {
        return { cls: 'expired', badge: `<span class="badge exp">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>`, order: 1, statusText: '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' };
    }

    // --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏¢‡∏Å ‡∏õ‡∏µ-‡πÄ‡∏î‡∏∑‡∏≠‡∏ô-‡∏ß‡∏±‡∏ô ---
    let years = eff.getFullYear() - now.getFullYear();
    let months = eff.getMonth() - now.getMonth();
    let days = eff.getDate() - now.getDate();

    // ‡∏õ‡∏£‡∏±‡∏ö‡∏ó‡∏î‡πÄ‡∏•‡∏Ç: ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏•‡∏ö ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏¢‡∏∑‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    if (days < 0) {
        months--;
        // ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡∏°‡∏≤‡∏ö‡∏ß‡∏Å
        const prevMonthLastDay = new Date(eff.getFullYear(), eff.getMonth(), 0).getDate();
        days += prevMonthLastDay;
    }
    // ‡∏õ‡∏£‡∏±‡∏ö‡∏ó‡∏î‡πÄ‡∏•‡∏Ç: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡∏¥‡∏î‡∏•‡∏ö ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏¢‡∏∑‡∏°‡∏õ‡∏µ
    if (months < 0) {
        years--;
        months += 12;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á (Label)
    let label = '';
    if (years > 0) {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏õ‡∏µ: ‡πÅ‡∏™‡∏î‡∏á "‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡∏õ‡∏µ 2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"
        label = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${years} ‡∏õ‡∏µ ${months} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
    } else if (months > 0) {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏õ‡∏µ ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡πÅ‡∏™‡∏î‡∏á "‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 5 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 10 ‡∏ß‡∏±‡∏ô"
        label = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${months} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${days} ‡∏ß‡∏±‡∏ô`;
    } else {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡πÅ‡∏™‡∏î‡∏á "‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 15 ‡∏ß‡∏±‡∏ô"
        label = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${days} ‡∏ß‡∏±‡∏ô`;
    }

    // 2. ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (WARNING_DAYS = 730 ‡∏ß‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ 2 ‡∏õ‡∏µ)
    if (totalDays <= WARNING_DAYS) {
        return { cls: 'warning', badge: `<span class="badge warn">${label}</span>`, order: 2, statusText: label };
    }

    // 3. ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏≠‡∏≤‡∏¢‡∏∏‡∏¢‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏¢‡∏≠‡∏∞‡∏Å‡∏ß‡πà‡∏≤ 2 ‡∏õ‡∏µ)
    return { cls: '', badge: `<span class="badge ok">‡∏õ‡∏Å‡∏ï‡∏¥</span>`, order: 3, statusText: '‡∏õ‡∏Å‡∏ï‡∏¥' };
}
// =============== render ===============
function renderTable(q=''){
  const tb = $('tbody');
  if(!filteredRows.length){ tb.innerHTML = `<tr><td colspan="14" class="small">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`; $('adminCount').textContent = ''; return; }
  tb.innerHTML = filteredRows.map((r,i) => {
    // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡πÅ‡∏ñ‡∏ß
    let statusClass = '';
    if (r.renewed_status === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß') statusClass = 'st-done';
    else if (r.renewed_status === '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') statusClass = 'st-process';
    else if (r.renewed_status === '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà') statusClass = 'st-change'; // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
else if (r.renewed_status === '‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏') statusClass = 'st-cancel'; // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    return `
    <tr class="${r.cls} ${statusClass}">
      <td><input type="checkbox" class="rowchk" data-id="${esc(r.id)}" ${selectedIds.has(r.id)?'checked':''}></td>
      <td>${i+1}</td>
      <td>${esc(r.company_code||'')}</td>
<td class="editable" data-id="${esc(r.id)}" data-field="brand_name">
    <strong>${esc(r.brand_name||'')}</strong> 
      ${ r.renewed_note ? `<div style="color: #0ea5a5; font-size: 11px; margin-top: 4px; border-left: 2px solid #0ea5a5; padding-left: 5px;">${esc(r.renewed_note)}</div>` : '' }
  </td>   
    <td class="editable" data-id="${esc(r.id)}" data-field="common_label">${esc(r.common_label||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="registration_no">${esc(r.registration_no||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="importer">${esc(r.importer||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="manufacturer_source">${esc(r.manufacturer_source||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="distributor">${esc(r.distributor||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="packed_volume">${esc(r.packed_volume||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="registration_date" data-raw="${esc(toISO(r.registration_date)||'')}">${r.registration_date?fmtDateBE(r.registration_date):''}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="expiry_date" data-raw="${esc(toISO(r.expiry_date)||'')}">${r.expiry_date?fmtDateBE(r.expiry_date):''}</td>
      <td>${r.badge} <div style="font-size:12px; color:#555; margin-top:2px;">${esc(r.renewed_status||'')}</div></td>
      
      <td style="white-space:nowrap">
        <div style="display:flex; flex-direction:column; gap:4px;">
           <div style="display:flex; align-items:center; gap:2px;">
              <button class="btn btn-ghost small" style="padding:4px 8px;" onclick="openNote('${esc(r.id)}')">üìù ‡∏à‡∏î‡πÇ‡∏ô‡πâ‡∏ï</button>
              ${ r.renewed_note ? `<button class="btn btn-ghost small" style="padding:4px 6px; color:red; font-size:12px;" onclick="clearNote('${esc(r.id)}')" title="‡∏•‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏">x</button>` : '' }
           </div>
           
           <div style="display:flex; align-items:center; gap:2px;">
              <button class="btn btn-ghost small" style="padding:4px;" title="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" onclick="setStatus('${esc(r.id)}','‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')">‚è≥</button>
              <button class="btn btn-primary small" style="padding:4px;" title="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß" onclick="setStatus('${esc(r.id)}','‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß')">‚úÖ</button>
              
              <button class="btn btn-ghost small" style="padding:4px; color:#0891b2;" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà" onclick="setStatus('${esc(r.id)}','‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà')">üè≠</button>
              <button class="btn btn-ghost small" style="padding:4px; color:#64748b;" title="‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏" onclick="setStatus('${esc(r.id)}','‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏')">‚úñÔ∏è</button>

              <span style="border-left:1px solid #ddd; margin:0 4px; height:16px;"></span>
              <button class="btn btn-ghost small" style="padding:4px; color:#f59e0b;" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" onclick="clearStatus('${esc(r.id)}')">üö´</button>
              <button class="btn btn-ghost small" style="padding:4px; color:#b91c1c;" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" onclick="delDoc('${esc(r.id)}')">üóëÔ∏è</button>
           </div>
        </div>
      </td>
    </tr>
  `}).join('');

  document.querySelectorAll('.rowchk').forEach(chk=>{
    chk.addEventListener('change', (e)=>{
      const id = e.target.dataset.id;
      if(e.target.checked) selectedIds.add(id); else selectedIds.delete(id);
      $('adminCount').textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${selectedIds.size} / ‡πÅ‡∏™‡∏î‡∏á ${filteredRows.length} / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${cachedRows.length}`;
    });
  });

  // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà ---
  const total = cachedRows.length;
  const notRenewed = cachedRows.filter(r => r.renewed_status === '‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏').length;
  const active = total - notRenewed;

  $('adminCount').textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total} | ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà: ${active} | ‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏: ${notRenewed} | (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà: ${selectedIds.size})`;
  // -----------------------

  $('chkAllVisible').checked = filteredRows.length > 0 && filteredRows.every(r => selectedIds.has(r.id));
}

// =============== filter logic ===============
function applyFilter(){
  const q = ($('adminSearch').value||'').trim().toLowerCase();
  const selectedYear = $('yearFilter').value; // üü¢ ‡∏î‡∏∂‡∏á‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠

  const toks = q.split(/\s+/).filter(Boolean);
  
  filteredRows = cachedRows.filter(r => {
    // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const hay = [r.brand_name, r.common_label, r.registration_no, r.importer, r.manufacturer_source, r.distributor, r.packed_volume].join(' ').toLowerCase();
    const matchesSearch = toks.every(t => hay.includes(t));

    // 2. üü¢ ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (registration_date)
    let matchesYear = true;
    if (selectedYear !== 'all' && r.registration_date) {
      const regDate = new Date(r.registration_date);
      matchesYear = regDate.getFullYear().toString() === selectedYear;
    } else if (selectedYear !== 'all' && !r.registration_date) {
      matchesYear = false; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á
    }

    return matchesSearch && matchesYear;
  });
  
  renderTable();
}
// ===== filter buttons: reg/import/pack =====
$('filterAllBtn').addEventListener('click', ()=>{ filteredRows = [...cachedRows]; renderTable(); });
$('filterRegBtn').addEventListener('click', ()=>{ filteredRows = cachedRows.filter(r => r.registration_no && r.registration_no.trim() !== ''); renderTable(); });
$('filterImportBtn').addEventListener('click', ()=>{ filteredRows = cachedRows.filter(r => { const pv = String(r.packed_volume||'').toLowerCase(); const imp = String(r.importer||'').toLowerCase(); return pv.includes('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤') || imp.includes('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤') || pv.includes('import') || imp.includes('import'); }); renderTable(); });
$('filterPackBtn').addEventListener('click', ()=>{ filteredRows = cachedRows.filter(r => { const pv = String(r.packed_volume||'').toLowerCase(); return pv.includes('‡πÅ‡∏ö‡πà‡∏á') || pv.includes('‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏') || pv.includes('repack') || pv.includes('‡πÅ‡∏ö‡πà‡∏á '); }); renderTable(); });

// =============== add new ===============
$('addBtn').addEventListener('click', async ()=>{ 
  if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô');
  const payload = {
    company_code: currentCompany,
    brand_name: $('brand_name').value.trim(),
    common_label: $('common_label').value.trim(),
    registration_no: $('registration_no').value.trim() || null,
    importer: $('importer').value.trim() || null,
    manufacturer_source: $('manufacturer_source').value.trim() || null,
    distributor: $('distributor').value.trim() || null,
    packed_volume: $('packed_volume').value.trim() || null,
    registration_date: $('registration_date').value || null,
    expiry_date: $('expiry_date').value || null
  };
  if(!payload.brand_name || !payload.common_label) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£');
  try{
    const { error } = await sb.from(REG_TABLE).insert(payload);
    if(error) throw error;
    ['brand_name','common_label','registration_no','importer','manufacturer_source','distributor','packed_volume','registration_date','expiry_date'].forEach(id=>{ if($(id)) $(id).value=''; });
    loadDocs(currentCompany);
  }catch(e){ alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});

// =============== inline edit ===============
(function initInlineEdit(){
  const tb = $('tbody');
  tb.addEventListener('dblclick', (e)=>{
    const td = e.target.closest('td.editable');
    if(!td) return;
    if(td.classList.contains('editing')) return;
    td.classList.add('editing');
    const id = td.dataset.id;
    const field = td.dataset.field;
    const old = td.getAttribute('data-raw') || td.textContent.trim();
    const input = document.createElement('input');
    input.style.width = '100%';
    if(field.includes('date')){ input.type='date'; input.value = td.getAttribute('data-raw') || ''; }
    else input.value = td.textContent.trim();
    td.innerHTML = ''; td.appendChild(input); input.focus();
    const finish = async (commit)=>{
      td.classList.remove('editing');
      if(!commit){ td.innerHTML = field.includes('date') ? (td.getAttribute('data-raw')?fmtDateBE(td.getAttribute('data-raw')):'') : esc(old); return; }
      const payload = {}; payload[field] = field.includes('date') ? (input.value||null) : (input.value.trim()||null);
      try{
        const { error } = await sb.from(REG_TABLE).update(payload).eq('id', id);
        if(error) throw error;
        loadDocs(currentCompany);
      }catch(e){ alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); td.innerHTML = esc(old); }
    };
    input.addEventListener('keydown', ev=>{ if(ev.key==='Enter'){ ev.preventDefault(); finish(true);} if(ev.key==='Escape'){ finish(false); }});
    input.addEventListener('blur', ()=> finish(true));
  });
})();

// =============== notes / status / delete ===============
window.openNote = (id)=>{
  editingNoteId = id;
  const row = cachedRows.find(r=>r.id==id);
  $('noteText').value = row?.renewed_note || '';
  $('noteModal').style.display = 'flex';
};
$('closeNote').addEventListener('click', ()=> $('noteModal').style.display='none');
$('saveNote').addEventListener('click', async ()=>{
  if(!editingNoteId) return;
  try{
    const { error } = await sb.from(REG_TABLE).update({ renewed_note: $('noteText').value }).eq('id', editingNoteId);
    if(error) throw error;
    $('noteModal').style.display='none';
    loadDocs(currentCompany);
  }catch(e){ alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});

window.setStatus = async function(id, statusText){
  try{
    const { error } = await sb.from(REG_TABLE).update({ renewed_status: statusText, renewed_on: new Date().toISOString() }).eq('id', id);
    if(error) throw error;
    loadDocs(currentCompany);
  }catch(e){ alert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
};

window.delDoc = async function(id){
  if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  try{
    const { error } = await sb.from(REG_TABLE).delete().eq('id', id);
    if(error) throw error;
    loadDocs(currentCompany);
  }catch(e){ alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
};

// bulk delete
$('btnDeleteSel').addEventListener('click', async ()=>{
  if(selectedIds.size===0) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô');
  if(!confirm(`‡∏•‡∏ö ${selectedIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) return;
  try{
    const ids = Array.from(selectedIds).map(x=>Number(x));
    const { error } = await sb.from(REG_TABLE).delete().in('id', ids);
    if(error) throw error;
    selectedIds.clear(); loadDocs(currentCompany);
  }catch(e){ alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});

// =============== set customer code RPC-like ===============
$('setCodeBtn').addEventListener('click', async ()=>{
  if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó');
  const code = $('cust_code').value.trim(); if(!code) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™');
  try{
    const { error } = await sb.from(COMPANIES_TABLE).upsert({ code: currentCompany, plain_code: code }, { onConflict: 'code' });
    if(error) throw error;
    toast('‡∏ï‡∏±‡πâ‡∏á/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    loadCompanies();
  }catch(e){ alert('‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});
$('copyCodeBtn').addEventListener('click', async ()=>{ const code = $('cust_code').value.trim(); if(!code) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™'); await navigator.clipboard.writeText(code); alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'); });

// =============== template, preview, import, export ===============
$('tplBtn').addEventListener('click', ()=>{
  const headers = ['brand_name','common_label','registration_no','importer','manufacturer_source','distributor','packed_volume','registration_date','expiry_date','license_no'];
  const example = ['‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á','‡∏™‡∏π‡∏ï‡∏£X','REG-001','‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤','‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï X','‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢ Y','‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ 500 ‡∏°‡∏•.','2024-01-01','2026-01-01','LIC-001'];
  const aoa = [headers, example];
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'template');
  XLSX.writeFile(wb, 'template_registrations.xlsx');
});

$('chooseFileBtn').addEventListener('click', ()=> $('fileInput').click());

$('previewBtn').addEventListener('click', async ()=>{
  const f = $('fileInput').files[0]; if(!f) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô preview');
  try{
    const ab = await f.arrayBuffer();
    const wb = XLSX.read(ab, { type:'array', raw:true }); // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏° raw: true
    const ws = wb.Sheets[wb.SheetNames[0]];
    // ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ header: 1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô Array of Arrays ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Preview
    const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:'', raw:true }); 
    // ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ { header: 1 } ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö preview
    const table = document.createElement('table'); table.style.width='100%'; table.border=1;
    rows.slice(0,11).forEach((r)=>{ const tr = table.insertRow(); r.forEach(c=>{ const td = tr.insertCell(); td.textContent = c; }); });
    const pa = $('previewArea'); pa.innerHTML=''; pa.appendChild(table);
    pa.insertAdjacentHTML('afterbegin', `<div class="small">Preview: ‡πÅ‡∏ñ‡∏ß‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡πÅ‡∏ñ‡∏ß ‚Äî ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏Å‡∏î Import to Server</div>`);
  }catch(e){ alert('Preview ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});

// ================= 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô normalizeDate ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Date Object ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô =================
function normalizeDate(v) {
    if (!v && v !== 0) return null;
    
    // ‡∏Å‡∏£‡∏ì‡∏µ SheetJS ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Date Object (‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ cellDates: true)
    if (v instanceof Date && !isNaN(v)) {
        // ‡∏õ‡∏£‡∏±‡∏ö Timezone ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Local Date (‡∏ï‡∏±‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡πà‡∏≠‡∏°‡∏ß‡∏±‡∏ô)
        const offset = v.getTimezoneOffset() * 60000;
        const localDate = new Date(v.getTime() - offset);
        return localDate.toISOString().slice(0, 10);
    }

    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (Excel Serial Date)
    if (typeof v === 'number' && isFinite(v)) {
        const epoch = new Date(Math.round((v - 25569) * 86400 * 1000));
        return epoch.toISOString().slice(0, 10);
    }

    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Text String (dd/mm/yyyy ‡∏´‡∏£‡∏∑‡∏≠ yyyy-mm-dd)
    if (typeof v === 'string') {
        let s = v.trim().replace(/\./g, '/').replace(/\s+/g, '');
        // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡∏£‡∏ö‡∏¥‡∏Å
        const thnums = { '‡πê': '0', '‡πë': '1', '‡πí': '2', '‡πì': '3', '‡πî': '4', '‡πï': '5', '‡πñ': '6', '‡πó': '7', '‡πò': '8', '‡πô': '9' };
        s = s.replace(/[‡πê-‡πô]/g, ch => thnums[ch] ?? ch);

        // ‡∏•‡∏≠‡∏á‡πÅ‡∏°‡∏ï‡∏ä‡πå yyyy-mm-dd
        let m = s.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/);
        if (m) return `${m[1]}-${m[2].padStart(2, '0')}-${m[3].padStart(2, '0')}`;

        // ‡∏•‡∏≠‡∏á‡πÅ‡∏°‡∏ï‡∏ä‡πå d/m/yyyy ‡∏´‡∏£‡∏∑‡∏≠ d/m/yy
        m = s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})$/);
        if (m) {
            let d = parseInt(m[1], 10), mo = parseInt(m[2], 10), y = parseInt(m[3], 10);
            if (y < 100) y += (y >= 70 ? 1900 : 2000); // ‡πÄ‡∏î‡∏≤‡∏õ‡∏µ 2 ‡∏´‡∏•‡∏±‡∏Å
            if (y > 2400) y -= 543; // ‡πÅ‡∏õ‡∏•‡∏á ‡∏û.‡∏®. -> ‡∏Ñ.‡∏®.
            return `${y}-${String(mo).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        }
    }
    return null;
}
// ================= ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô pick (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞ Import ‡πÑ‡∏î‡πâ) =================
function pick(obj, keys) {
    if (!obj || typeof obj !== 'object') return '';
    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏´‡∏≤ key ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å/‡πÉ‡∏´‡∏ç‡πà)
    for (const k of keys) {
        const searchKey = k.toLowerCase().trim();
        for (const rawKey in obj) {
            if (rawKey.toLowerCase().trim() === searchKey) {
                return obj[rawKey];
            }
        }
    }
    return '';
}
// ================= 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏∏‡πà‡∏° Import ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ cellDates: true ‡πÅ‡∏•‡∏∞ Log ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• =================
$('impBtn').addEventListener('click', async () => {
    const f = $('fileInput').files[0];
    if (!f) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î Import');
    if (!currentCompany) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤');

    if ($('replaceMode').checked && !confirm('‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

    try {
        const ab = await f.arrayBuffer();
        
        // --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ cellDates: true ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ---
        const wb = XLSX.read(ab, { type: 'array', cellDates: true }); 
        const ws = wb.Sheets[wb.SheetNames[0]];
        // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ raw: true ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ SheetJS ‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Type ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
        const rows = XLSX.utils.sheet_to_json(ws, { defval: '' }); 

        console.log('Raw Rows from Excel:', rows.slice(0, 3)); // ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡πÉ‡∏ô Console (F12)

        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£ Map ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÉ‡∏ô impBtn) ---

        const mapped = rows.map(r => {
            const brand = pick(r, ['brand_name', '‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤', 'brand']);
            const common = pick(r, ['common_label', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç', '‡∏™‡∏π‡∏ï‡∏£']);
            const regno = pick(r, ['registration_no', '‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', '‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', 'registration']);
            const importer = pick(r, ['importer', '‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤']);
            const manu = pick(r, ['manufacturer_source', '‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï', '‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï']);
            const distrib = pick(r, ['distributor', '‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢']);
            const packed = pick(r, ['packed_volume', '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏', 'packed_volume']);
            const regdate = pick(r, ['registration_date', '‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô']);
            const exp = pick(r, ['expiry_date', '‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏', '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏¥‡∏°', 'expiry_date']);
            
            // 1. ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" ‡πÅ‡∏•‡∏∞ "‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï" ‡∏à‡∏≤‡∏Å Excel
            const note = pick(r, ['renewed_note', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', 'Note', 'license_no', '‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï']);

            const registration_date = normalizeDate(regdate);
            const expiry_date = normalizeDate(exp);

            return {
                company_code: currentCompany,
                brand_name: String(brand || '').trim(),
                common_label: String(common || '').trim(),
                registration_no: String(regno || '').trim() || null,
                importer: String(importer || '').trim() || null,
                manufacturer_source: String(manu || '').trim() || null,
                distributor: String(distrib || '').trim() || null,
                packed_volume: String(packed || '').trim() || null,
                registration_date: registration_date || null,
                expiry_date: expiry_date || null,
                
                // 2. ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ó‡∏µ‡πà renewed_note ‡πÅ‡∏ó‡∏ô license_no
                renewed_note: String(note || '').trim() || null
                
                // (‡∏•‡∏ö license_no ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏õ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö)
            };
        }).filter(x => x.brand_name && x.common_label);

        console.log('Mapped Data to Insert:', mapped); // ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ Supabase ‡πÉ‡∏ô Console

        if (mapped.length === 0) {
            return alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! \n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô Excel ‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤: "‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤", "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà');
        }

        // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Replace
        if ($('replaceMode').checked) {
            const del = await sb.from(REG_TABLE).delete().eq('company_code', currentCompany);
            if (del.error) throw new Error('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + del.error.message);
        }

        // ‡∏ó‡∏¢‡∏≠‡∏¢ Insert ‡∏ó‡∏µ‡∏•‡∏∞ 500 ‡πÅ‡∏ñ‡∏ß
        let successCount = 0;
        for (let i = 0; i < mapped.length; i += 500) {
            const chunk = mapped.slice(i, i + 500);
            const { error } = await sb.from(REG_TABLE).insert(chunk);
            if (error) {
                console.error('Insert Error Chunk ' + i, error);
                throw new Error('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message + ' (Check Console)');
            }
            successCount += chunk.length;
        }

        toast(`‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
        loadDocs(currentCompany); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        $('fileInput').value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÑ‡∏ü‡∏•‡πå

    } catch (err) {
        console.error('FULL IMPORT ERROR:', err);
        alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (err.message || err));
    }
});
// export xlsx
$('expBtn').addEventListener('click', async ()=>{
  if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
  try{
    const rows = cachedRows || [];
    const aoa = [['‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó','‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£','‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô','‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤','‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï/‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï','‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢','‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏','‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô','‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏','‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']];
    rows.forEach(r=> aoa.push([r.company_code||'', r.brand_name||'', r.common_label||'', r.registration_no||'', r.importer||'', r.manufacturer_source||'', r.distributor||'', r.packed_volume||'', r.registration_date?toISO(r.registration_date):'', r.expiry_date?toISO(r.expiry_date):'', r.license_no||'', r.statusText||'' ]));
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, currentCompany.slice(0,31)); XLSX.writeFile(wb, `registrations_${currentCompany}.xlsx`);
  }catch(e){ alert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
});

// =============== misc events ===============
$('fileInput').addEventListener('change', ()=> $('previewBtn').click());
$('companySelect').addEventListener('change', e=> { if(e.target.value) loadDocs(e.target.value); });
$('adminSearch').addEventListener('input', ()=> applyFilter());
$('adminClearBtn').addEventListener('click', ()=> { $('adminSearch').value=''; applyFilter(); });
$('btnSelectAllFiltered').addEventListener('click', ()=> filteredRows.forEach(r=> selectedIds.add(r.id)) || renderTable());
$('btnClearSel').addEventListener('click', ()=> selectedIds.clear() || renderTable());
$('signOutBtn').addEventListener('click', async ()=> { await sb.auth.signOut(); sessionStorage.removeItem('legacy_admin_key'); location.href = '/admin_login.html'; });
// ================= ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / ‡∏•‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ =================

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤ renewed_status)
window.clearStatus = async function(id){
  if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  try{
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô null (‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á)
    const { error } = await sb.from(REG_TABLE).update({ renewed_status: null }).eq('id', id);
    if(error) throw error;
    loadDocs(currentCompany); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  }catch(e){ alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
};

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤ renewed_note)
window.clearNote = async function(id){
  if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" ‡∏ó‡∏¥‡πâ‡∏á‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  try{
    const { error } = await sb.from(REG_TABLE).update({ renewed_note: null }).eq('id', id);
    if(error) throw error;
    loadDocs(currentCompany);
  }catch(e){ alert('‡∏•‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(e.message||e)); }
};
// üü¢ ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏µ‡πÉ‡∏ô Dropdown
$('yearFilter').addEventListener('change', () => applyFilter());
// start
document.addEventListener('DOMContentLoaded', async ()=>{
  // legacy key auto-login for dev
  if(LEGACY_ADMIN_KEY && LEGACY_ADMIN_KEY !== 'PUT_ADMIN_KEY_HERE') sessionStorage.setItem('legacy_admin_key', LEGACY_ADMIN_KEY);
  try{
    const { data: { session } } = await sb.auth.getSession();
    // if no session and no legacy key, you can still load companies if anon has rights
  }catch(e){ console.error(e); }
  await loadCompanies();
});

// ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà "‡πÑ‡∏°‡πà" ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤ "‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏"
$('filterActiveBtn').addEventListener('click', ()=>{ 
    filteredRows = cachedRows.filter(r => r.renewed_status !== '‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏'); 
    renderTable(); 
});

// ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà "‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
$('filterCancelBtn').addEventListener('click', ()=>{ 
    filteredRows = cachedRows.filter(r => r.renewed_status === '‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏'); 
    renderTable(); 
});
// expose some for console
window.openNote = openNote;
window.setStatus = setStatus;
window.delDoc = delDoc;
window.loadDocs = loadDocs;
window.applyFilter = applyFilter;
window.loadCompanies = loadCompanies;

</script>
</body>
</html>
