<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Portal ‚Äî ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Proxy)</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f6fbff;--card:#fff;--mut:#64748b;--border:#e6eef5;--accent:#0ea5a5;--accent2:#60a5fa}
  body{font-family:"Prompt",sans-serif;background:var(--bg);margin:0;color:#0f172a}
  header{padding:16px;background:linear-gradient(180deg,#f0fbff,#eaf7ff);border-bottom:1px solid var(--border)}
  .wrap{max-width:1100px;margin:18px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 8px 28px rgba(10,30,60,.06)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,button,textarea{padding:10px;border-radius:10px;border:1px solid var(--border);font-size:14px;background:#fff}
  .btn{cursor:pointer}
  .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;font-weight:700}
  .btn-ghost{background:#fff;border:1px solid #d6eef3;color:#0b6b6b}
  .small{font-size:13px;color:var(--mut)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
  th{background:linear-gradient(180deg,#f7fbff,#f2f8ff);position:sticky;top:0}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:9999}
  .modal-box{background:#fff;padding:16px;border-radius:12px;width:760px;max-width:96%}
  td.editable{cursor:text}
  td.editing{background:#fffbe6}
</style>
</head>
<body>
<header>
  <div style="max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:12px">
    <div style="font-weight:700">Admin Portal ‚Äî ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
    <div style="flex:1"></div>
    <button id="signOutBtn" class="btn btn-ghost">Sign out</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <label><strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</strong></label>
    <div class="row">
      <select id="companySelect" style="min-width:260px"><option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option></select>
      <div style="flex:1"></div>
      <input id="cust_code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô RG-1234" style="min-width:220px">
      <button id="setCodeBtn" class="btn btn-primary">‡∏ï‡∏±‡πâ‡∏á/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™</button>
      <button id="copyCodeBtn" class="btn btn-ghost">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™</button>
    </div>
    <div id="msg" class="small" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <label><strong>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ / ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å (Preview + Proxy)</strong></label>
    <div class="row">
      <button id="tplBtn" class="btn btn-ghost">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï</button>
      <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display:none">
      <button id="previewBtn" class="btn btn-ghost">Preview</button>
      <button id="impBtn" class="btn btn-primary">Import to Server</button>
      <button id="expBtn" class="btn btn-ghost">Export Excel</button>
      <label style="margin-left:8px"><input type="checkbox" id="replaceMode"> ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ô‡∏µ‡πâ</label>
    </div>
    <div id="previewArea" style="margin-top:12px"></div>
  </div>

  <div class="card">
    <label><strong>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏î‡πà‡∏ß‡∏ô)</strong></label>
    <div class="row" style="align-items:center">
      <input id="brand_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤">
      <input id="common_label" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç+‡∏™‡∏π‡∏ï‡∏£" style="min-width:220px">
      <input id="registration_no" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô">
      <input id="importer" placeholder="‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤">
      <input id="manufacturer_source" placeholder="‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï / ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï">
      <input id="distributor" placeholder="‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢">
      <input id="packed_volume" placeholder="‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏" style="min-width:140px">
      <input id="registration_date" type="date" placeholder="‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô">
      <input id="expiry_date" type="date" placeholder="‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏">
      <button id="addBtn" class="btn btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    </div>
  </div>

  <div class="card" style="overflow:auto; max-height:64vh">
    <div class="row" style="margin-bottom:8px">
      <input id="adminSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç / ‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô / ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ..." style="min-width:360px">
      <button id="adminClearBtn" class="btn btn-ghost">‡∏•‡πâ‡∏≤‡∏á</button>
      <div style="flex:1"></div>
      <div id="adminCount" class="small"></div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button id="btnSelectAllFiltered" class="btn btn-ghost small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ú‡∏•‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)</button>
      <button id="btnClearSel" class="btn btn-ghost small">‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
      <button id="btnDeleteSel" class="btn btn-danger small">‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
      <div style="flex:1"></div>
      <button id="btnNotePage" class="btn btn-ghost small">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
    <div style="display:flex;gap:8px;margin-left:8px">
  <button id="filterAllBtn" class="btn btn-ghost small">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  <button id="filterRegBtn" class="btn btn-ghost small">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
  <button id="filterImportBtn" class="btn btn-ghost small">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤"</button>
  <button id="filterPackBtn" class="btn btn-ghost small">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏"</button>
</div>
<div style="flex:1"></div>
      <div id="adminCount" class="small"></div>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width:36px"><input id="chkAllVisible" type="checkbox"></th>
          <th>#</th><th>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç+‡∏™‡∏π‡∏ï‡∏£</th><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
          <th>‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</th><th>‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï/‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï</th><th>‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</th><th>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤/‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏à‡∏∏</th>
          <th>‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th><th>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td colspan="14" class="small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</td></tr></tbody>
    </table>
  </div>
</div>

<!-- note modal -->
<div id="noteModal" class="modal"><div class="modal-box"><div style="display:flex;justify-content:space-between;align-items:center">
  <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</strong><button id="closeNote" class="btn btn-ghost">‡∏õ‡∏¥‡∏î</button></div>
  <textarea id="noteText" style="width:100%;min-height:140px;margin-top:8px"></textarea>
  <div style="display:flex;justify-content:flex-end;margin-top:8px"><button id="saveNote" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
</div></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// ‚úÖ Supabase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const SUPABASE_URL = 'https://jlrogimfjmtwdqiuyejj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impscm9naW1mam10d2RxaXV5ZWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDIyODUsImV4cCI6MjA3NTUxODI4NX0.OvX7qgcIF5aCcLebUEUR_6D2KTUP2pALCjRtHWJ5qZg';
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// üîí ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤): ‡∏ù‡∏±‡∏á legacy admin key ‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ auto-login
// ‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏ù‡∏±‡∏á‡∏Ñ‡∏µ‡∏¢‡πå‡∏à‡∏£‡∏¥‡∏á‡∏•‡∏á production ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏Ñ‡∏£‡πÄ‡∏õ‡∏¥‡∏î devtools ‡∏Å‡πá‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ
const LEGACY_ADMIN_KEY = 'PPHASIN2556';  // <-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

if (typeof window !== 'undefined' && LEGACY_ADMIN_KEY && LEGACY_ADMIN_KEY !== 'PUT_ADMIN_KEY_HERE') {
  sessionStorage.setItem('legacy_admin_key', LEGACY_ADMIN_KEY);
}


const $ = id => document.getElementById(id);
const WARNING_DAYS = 90;
let currentCompany = '';
let cachedRows = [];
let filteredRows = [];
const selectedIds = new Set();
let editingNoteId = null;

// helper
function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function fmtDateBE(d){ if(!d) return ''; const t=new Date(d); if(isNaN(t)) return ''; try{ return t.toLocaleDateString('th-TH-u-ca-buddhist',{year:'numeric',month:'short',day:'numeric', timeZone:'Asia/Bangkok'}); }catch(e){ return t.toISOString().split('T')[0];} }
function toISO(d){ if(!d) return ''; const t=new Date(d); return isNaN(t)?'':t.toISOString().slice(0,10); }

// --- AUTH / legacy key support ---
function getAuthHeaders(){
  // prefer Supabase session token if exist
  const token = sb.auth.getSession ? (sb.auth.getSession().then(s=>s)) : null;
  // faster: try legacy in sessionStorage
  const legacy = sessionStorage.getItem('legacy_admin_key');
  if(legacy) return { 'x-admin-key': legacy };
  // else try supabase session sync
  // We will do server calls without Authorization header if legacy key present; server can accept JWT too if provided
  return {};
}

// --- UI: load companies via proxy ---
async function loadCompanies(){
  const sel = $('companySelect');
  sel.innerHTML = `<option value="">‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‚Äî</option>`;
  try{
    const res = await fetch('/api/admin/companies', { method:'GET', headers: getAuthHeaders() });
    const j = await res.json();
    if(!res.ok) throw new Error(j.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÑ‡∏î‡πâ');
    const data = j.rows || [];
    sel.innerHTML = `<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‚Äî</option>` + data.map(c=>`<option value="${esc(c.code)}">${esc(c.code)} ${c.name?'- '+esc(c.name):''}</option>`).join('');
  }catch(e){
    sel.innerHTML = `<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>`;
    console.error(e);
  }
}

// --- list rows via proxy ---
async function loadDocs(code){
  currentCompany = code;
  selectedIds.clear();
  $('cust_code').value = '';
  if(!code){ $('tbody').innerHTML = `<tr><td colspan="14" class="small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</td></tr>`; $('adminCount').textContent=''; return; }
  try{
    const res = await fetch(`/api/admin/list?code=${encodeURIComponent(code)}&limit=200&offset=0`, { headers: getAuthHeaders() });
    const j = await res.json();
    if(!res.ok) throw new Error(j.error || 'load failed');
    const data = j.rows || [];
    cachedRows = data.map(r => ({ ...r, ...classify(r.expiry_date) }));
    filteredRows = [...cachedRows];
    renderTable();
    // try to fetch customer_code if available
    const codeRes = await fetch(`/api/admin/company-code?code=${encodeURIComponent(code)}`, { headers: getAuthHeaders() });
    if(codeRes.ok){ const cc = await codeRes.json(); $('cust_code').value = cc.plain_code || ''; }
  }catch(e){
    console.error(e);
    $('tbody').innerHTML = `<tr><td colspan="14" class="small">${esc(e.message)}</td></tr>`;
  }
}

// --- classify ---
function classify(expiry){
  if(!expiry) return { cls:'', badge:`<span class="small">‡∏õ‡∏Å‡∏ï‡∏¥</span>`, order:3, statusText:'‡∏õ‡∏Å‡∏ï‡∏¥' };
  const eff = new Date(expiry);
  if(isNaN(eff)) return { cls:'', badge:`<span class="small">‡∏õ‡∏Å‡∏ï‡∏¥</span>`, order:3, statusText:'‡∏õ‡∏Å‡∏ï‡∏¥' };
  const diff = Math.ceil((eff - new Date())/86400000);
  if(diff < 0) return { cls:'expired', badge:`<span class="small">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</span>`, order:1, statusText:'‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏' };
  if(diff <= WARNING_DAYS) return { cls:'warning', badge:`<span class="small">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${diff} ‡∏ß‡∏±‡∏ô</span>`, order:2, statusText:`‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${diff} ‡∏ß‡∏±‡∏ô` };
  return { cls:'', badge:`<span class="small">‡∏õ‡∏Å‡∏ï‡∏¥</span>`, order:3, statusText:'‡∏õ‡∏Å‡∏ï‡∏¥' };
}

// --- render ---
function renderTable(q=''){
  const tb = $('tbody');
  if(!filteredRows.length){ tb.innerHTML = `<tr><td colspan="14" class="small">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`; $('adminCount').textContent = ''; return; }
  tb.innerHTML = filteredRows.map((r,i)=>`
    <tr class="${r.cls}">
      <td><input type="checkbox" class="rowchk" data-id="${esc(r.id)}" ${selectedIds.has(r.id)?'checked':''}></td>
      <td>${i+1}</td>
      <td>${esc(r.company_code||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="brand_name">${esc(r.brand_name||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="common_label">${esc(r.common_label||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="registration_no">${esc(r.registration_no||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="importer">${esc(r.importer||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="manufacturer_source">${esc(r.manufacturer_source||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="distributor">${esc(r.distributor||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="packed_volume">${esc(r.packed_volume||'')}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="registration_date" data-raw="${esc(toISO(r.registration_date)||'')}">${r.registration_date?fmtDateBE(r.registration_date):''}</td>
      <td class="editable" data-id="${esc(r.id)}" data-field="expiry_date" data-raw="${esc(toISO(r.expiry_date)||'')}">${r.expiry_date?fmtDateBE(r.expiry_date):''}</td>
      <td>${r.badge}</td>
      <td style="white-space:nowrap">
        <button class="btn btn-ghost" onclick="openNote('${esc(r.id)}')">üìù</button>
        <button class="btn btn-ghost" onclick="setStatus('${esc(r.id)}','‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')">‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á</button>
        <button class="btn btn-primary" onclick="setStatus('${esc(r.id)}','‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß')">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</button>
        <button class="btn btn-ghost" onclick="delDoc('${esc(r.id)}')">‡∏•‡∏ö</button>
      </td>
    </tr>
  `).join('');

  document.querySelectorAll('.rowchk').forEach(chk=>{
    chk.addEventListener('change', (e)=>{
      const id = e.target.dataset.id;
      if(e.target.checked) selectedIds.add(id); else selectedIds.delete(id);
      $('adminCount').textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${selectedIds.size} / ‡πÅ‡∏™‡∏î‡∏á ${filteredRows.length} / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${cachedRows.length}`;
    });
  });

  $('adminCount').textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${selectedIds.size} / ‡πÅ‡∏™‡∏î‡∏á ${filteredRows.length} / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${cachedRows.length}`;
  $('chkAllVisible').checked = filteredRows.length>0 && filteredRows.every(r=>selectedIds.has(r.id));
}

// --- filter ---
function applyFilter(){
  const q = ($('adminSearch').value||'').trim().toLowerCase();
  if(!q){ filteredRows = [...cachedRows]; renderTable(); return; }
  const toks = q.split(/\s+/).filter(Boolean);
  filteredRows = cachedRows.filter(r=>{
    const hay = [r.brand_name,r.common_label,r.registration_no,r.importer,r.manufacturer_source,r.distributor].join(' ').toLowerCase();
    return toks.every(t => hay.includes(t));
  });
  renderTable(q);
}

// --- add new (proxy) ---
$('addBtn').addEventListener('click', async ()=>{
  if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô');
  const payload = {
    company_code: currentCompany,
    brand_name: $('brand_name').value.trim(),
    common_label: $('common_label').value.trim(),
    registration_no: $('registration_no').value.trim() || null,
    importer: $('importer').value.trim() || null,
    manufacturer_source: $('manufacturer_source').value.trim() || null,
    distributor: $('distributor').value.trim() || null,
    packed_volume: $('packed_volume').value.trim() || null,
    registration_date: $('registration_date').value || null,
    expiry_date: $('expiry_date').value || null
  };
  if(!payload.brand_name || !payload.common_label) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£');
  try{
    const headers = getAuthHeaders();
    headers['Content-Type'] = 'application/json';
    const res = await fetch('/api/admin/product', { method:'POST', headers, body: JSON.stringify({ company_code: payload.company_code, company_name: null, product: payload }) });
    const j = await res.json();
    if(!res.ok) throw new Error(j.error || 'add failed');
    $('brand_name').value=''; $('common_label').value=''; $('registration_no').value='';
    loadDocs(currentCompany);
  }catch(e){ alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message); }
});

// --- inline edit (dblclick) ---
(function initInlineEdit(){
  const tb = $('tbody');
  tb.addEventListener('dblclick', (e)=>{
    const td = e.target.closest('td.editable');
    if(!td) return;
    if(td.classList.contains('editing')) return;
    td.classList.add('editing');
    const id = td.dataset.id;
    const field = td.dataset.field;
    const old = td.getAttribute('data-raw') || td.textContent.trim();
    const input = document.createElement('input');
    input.style.width = '100%';
    if(field.includes('date')){ input.type='date'; input.value = td.getAttribute('data-raw') || ''; }
    else input.value = td.textContent.trim();
    td.innerHTML = ''; td.appendChild(input); input.focus();
    const finish = async (commit)=>{
      td.classList.remove('editing');
      if(!commit){ td.innerHTML = field.includes('date') ? (td.getAttribute('data-raw')?fmtDateBE(td.getAttribute('data-raw')):'') : esc(old); return; }
      const payload = {}; payload[field] = field.includes('date') ? (input.value||null) : (input.value.trim()||null);
      try{
        const headers = getAuthHeaders(); headers['Content-Type']='application/json';
        const res = await fetch('/api/admin/product', { method:'POST', headers, body: JSON.stringify({ company_code: currentCompany, company_name: null, product: { id, ...payload } }) });
        const j = await res.json();
        if(!res.ok) throw new Error(j.error || 'update failed');
        // refresh local
        loadDocs(currentCompany);
      }catch(e){ alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message); td.innerHTML = esc(old); }
    };
    input.addEventListener('keydown', ev=>{ if(ev.key==='Enter'){ ev.preventDefault(); finish(true);} if(ev.key==='Escape'){ finish(false); }});
    input.addEventListener('blur', ()=> finish(true));
  });
})();

// --- notes / status / delete (via proxy) ---
window.openNote = (id)=>{
  editingNoteId = id;
  const row = cachedRows.find(r=>r.id===id);
  $('noteText').value = row?.renewed_note || '';
  $('noteModal').style.display = 'flex';
};
$('closeNote').addEventListener('click', ()=> $('noteModal').style.display='none');
$('saveNote').addEventListener('click', async ()=>{
  if(!editingNoteId) return;
  try{
    const headers = getAuthHeaders(); headers['Content-Type']='application/json';
    const res = await fetch('/api/admin/product', { method:'POST', headers, body: JSON.stringify({ company_code: currentCompany, company_name: null, product: { id: editingNoteId, renewed_note: $('noteText').value } }) });
    const j = await res.json();
    if(!res.ok) throw new Error(j.error||'save note failed');
    $('noteModal').style.display='none';
    loadDocs(currentCompany);
  }catch(e){ alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message); }
});

window.setStatus = async function(id, statusText){
  try{
    const headers = getAuthHeaders(); headers['Content-Type']='application/json';
    const res = await fetch('/api/admin/product', { method:'POST', headers, body: JSON.stringify({ company_code: currentCompany, company_name: null, product: { id, renewed_status: statusText, renewed_on: new Date().toISOString() } }) });
    const j = await res.json();
    if(!res.ok) throw new Error(j.error||'status failed');
    loadDocs(currentCompany);
  }catch(e){ alert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message); }
};

window.delDoc = async function(id){
  if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  try{
    const headers = getAuthHeaders();
    const res = await fetch(`/api/admin/product/${encodeURIComponent(id)}`, { method:'DELETE', headers });
    const j = await res.json();
    if(!res.ok) throw new Error(j.error || 'delete failed');
    loadDocs(currentCompany);
  }catch(e){ alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message); }
};

// --- bulk delete ---
$('btnDeleteSel').addEventListener('click', async ()=>{
  if(selectedIds.size===0) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô');
  if(!confirm(`‡∏•‡∏ö ${selectedIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) return;
  try{
    const ids = Array.from(selectedIds);
    const headers = getAuthHeaders(); headers['Content-Type']='application/json';
    const res = await fetch('/api/admin/bulk-delete', { method:'POST', headers, body: JSON.stringify({ ids })});
    const j = await res.json();
    if(!res.ok) throw new Error(j.error||'bulk delete failed');
    selectedIds.clear(); loadDocs(currentCompany);
  }catch(e){ alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message); }
});

// --- set customer code (RPC) ---
$('setCodeBtn').addEventListener('click', async ()=>{
  if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó');
  const code = $('cust_code').value.trim();
  if(!code) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™');
  try{
    const headers = getAuthHeaders(); headers['Content-Type']='application/json';
    const res = await fetch('/api/admin/set-customer-code', { method:'POST', headers, body: JSON.stringify({ company_code: currentCompany, plain_code: code })});
    const j = await res.json();
    if(!res.ok) throw new Error(j.error||'set code failed');
    alert('‡∏ï‡∏±‡πâ‡∏á/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    loadCompanies();
  }catch(e){ alert('‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message); }
});
$('copyCodeBtn').addEventListener('click', async ()=>{ const code = $('cust_code').value.trim(); if(!code) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™'); await navigator.clipboard.writeText(code); alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'); });

// --- Import / Preview / Export via proxy ---
$('tplBtn').addEventListener('click', ()=> {
  // ‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢) + ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß
  const headers = ['brand_name','common_label','registration_no','importer','manufacturer_source','distributor','packed_volume','registration_date','expiry_date','license_no'];
  const example = ['‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á','‡∏™‡∏π‡∏ï‡∏£X','REG-001','‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤','‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï X','‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢ Y','500 ‡∏°‡∏•.','2024-01-01','2026-01-01','LIC-001'];

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á CSV (UTF-8 + BOM ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Excel ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏£‡∏á encoding)
  const rows = [headers, example];
  const csv = rows.map(r => r.map(cell => {
    // escape double quotes
    const s = (cell === null || cell === undefined) ? '' : String(cell);
    return '"' + s.replace(/"/g, '""') + '"';
  }).join(',')).join('\r\n');

  const blob = new Blob(["\uFEFF", csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'template_registrations.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});


let lastFile = null;
$('previewBtn').addEventListener('click', async ()=>{
  const f = $('fileInput').files[0];
  if(!f) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô preview');
  lastFile = f;
  const ab = await f.arrayBuffer();
  const wb = XLSX.read(ab, { type:'array', cellDates:true });
  const ws = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:'' });
  // show first 10 rows
  const table = document.createElement('table'); table.style.width='100%'; table.border=1;
  rows.slice(0,11).forEach((r,ri)=>{
    const tr = table.insertRow();
    r.forEach(c=> { const td = tr.insertCell(); td.textContent = c; });
  });
  const pa = $('previewArea'); pa.innerHTML = ''; pa.appendChild(table);
  pa.insertAdjacentHTML('afterbegin', `<div class="small">Preview: ‡πÅ‡∏ñ‡∏ß‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡πÅ‡∏ñ‡∏ß ‚Äî ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏Å‡∏î Import to Server</div>`);
});

$('impBtn').addEventListener('click', async ()=>{
  const f = $('fileInput').files[0];
  if(!f) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô import');
  if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤');
  if($('replaceMode').checked && !confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  try{
    const fd = new FormData();
    fd.append('file', f);
    fd.append('company_code', currentCompany);
    fd.append('replace_mode', $('replaceMode').checked ? '1':'0');
    const headers = getAuthHeaders();
    const res = await fetch('/api/admin/import-csv', { method:'POST', headers, body: fd });
    const j = await res.json();
    if(!res.ok) throw new Error(j.error || 'import failed');
    alert(`Import finished: success=${j.results.success} failed=${j.results.failed}`);
    loadDocs(currentCompany);
  }catch(e){ alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message); }
});

$('expBtn').addEventListener('click', async ()=>{
  if(!currentCompany) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
  try{
    const headers = getAuthHeaders();
    const res = await fetch(`/api/admin/export?code=${encodeURIComponent(currentCompany)}`, { headers });
    if(!res.ok) { const j=await res.json(); throw new Error(j.error||'export failed'); }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `registrations_${currentCompany}.xlsx`; document.body.appendChild(a); a.click(); a.remove();
  }catch(e){ alert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message); }
});

// --- events & start ---
$('companySelect').addEventListener('change', e=> { if(e.target.value) loadDocs(e.target.value); });
$('adminSearch').addEventListener('input', ()=> applyFilter());
$('adminClearBtn').addEventListener('click', ()=> { $('adminSearch').value=''; applyFilter(); });
$('fileInput').addEventListener('change', ()=> $('previewBtn').click());
$('btnSelectAllFiltered').addEventListener('click', ()=> filteredRows.forEach(r=> selectedIds.add(r.id)) || renderTable());
$('btnClearSel').addEventListener('click', ()=> selectedIds.clear() || renderTable());

$('signOutBtn').addEventListener('click', async ()=> { await sb.auth.signOut(); sessionStorage.removeItem('legacy_admin_key'); location.href = '/admin_login.html'; });

// start
document.addEventListener('DOMContentLoaded', async ()=>{
  // session check: if no supabase session and no legacy key, redirect to login
  const legacy = sessionStorage.getItem('legacy_admin_key');
  const { data: { session } } = await sb.auth.getSession();
  if(!session && !legacy){ location.href = '/admin_login.html'; return; }
  await loadCompanies();
});

window.openNote = openNote;
window.setStatus = setStatus;
window.delDoc = delDoc;
window.loadDocs = loadDocs;
window.applyFilter = applyFilter;
window.loadCompanies = loadCompanies;

</script>
</body>
</html>
